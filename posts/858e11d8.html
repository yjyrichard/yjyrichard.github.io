<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Redis项目笔记 | Yangjiayu</title><meta name="keywords" content="项目"><meta name="author" content="Yangjiayu"><meta name="copyright" content="Yangjiayu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="达人探店，打卡等">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis项目笔记">
<meta property="og:url" content="https://yjyrichard.github.io/posts/858e11d8.html">
<meta property="og:site_name" content="Yangjiayu">
<meta property="og:description" content="达人探店，打卡等">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/9.png">
<meta property="article:published_time" content="2025-04-15T15:49:27.170Z">
<meta property="article:modified_time" content="2025-04-15T15:10:42.654Z">
<meta property="article:author" content="Yangjiayu">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/9.png"><link rel="shortcut icon" href="https://bilibili123.oss-cn-beijing.aliyuncs.com/about/your_image_path_here.jpg"><link rel="canonical" href="https://yjyrichard.github.io/posts/858e11d8"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"var(--theme-color)","bgDark":"#191919","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis项目笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-15 23:10:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Yangjiayu" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://bilibili123.oss-cn-beijing.aliyuncs.com/about/your_image_path_here.jpg" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">77</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> 八音盒</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> 影院</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> 健身</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/books/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> 时间管理</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> 恋爱小屋</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Yangjiayu</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> 八音盒</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> 影院</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> 健身</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/books/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> 个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> 时间管理</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> 恋爱小屋</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> 关于</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> 搜索</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="美化设置-自定义你的风格" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">Redis项目笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">发表于 </span><time class="post-meta-date-created" datetime="2025-04-15T15:49:27.170Z" title="发表于 2025-04-15 23:49:27">2025-04-15</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-15T15:10:42.654Z" title="更新于 2025-04-15 23:10:42">2025-04-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">字数总计:</span><span class="word-count">1.6w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">阅读时长:</span><span>62分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis项目笔记"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>Redis项目笔记</h1>
<h2 id="达人探店">达人探店</h2>
<h3 id="发布探店笔记">发布探店笔记</h3>
<p>这部分代码已经提供好了，我们来看看对应的数据表</p>
<ul>
<li>
<p>tb_blog</p>
</li>
<li>
<p>tb_blog_comments</p>
</li>
<li>
<p>其他用户对探店笔记的评价</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">auto_increment</td>
<td style="text-align:center">主键</td>
</tr>
<tr>
<td style="text-align:center">user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">用户id</td>
</tr>
<tr>
<td style="text-align:center">blog_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">探店id</td>
</tr>
<tr>
<td style="text-align:center">parent_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">关联的1级评论id，如果是一级评论，则值为0</td>
</tr>
<tr>
<td style="text-align:center">answer_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">回复的评论id</td>
</tr>
<tr>
<td style="text-align:center">content</td>
<td style="text-align:center">varchar(255)</td>
<td style="text-align:center">utf8mb4_general_ci</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">回复的内容</td>
</tr>
<tr>
<td style="text-align:center">liked</td>
<td style="text-align:center">int unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">点赞数</td>
</tr>
<tr>
<td style="text-align:center">status</td>
<td style="text-align:center">tinyint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">状态，0：正常，1：被举报，2：禁止查看</td>
</tr>
<tr>
<td style="text-align:center">create_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">创建时间</td>
</tr>
<tr>
<td style="text-align:center">update_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED on update CURRENT_TIMESTAMP</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>探店店笔记表，包含笔记中的标题、文字、图片等</p>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">auto_increment</td>
<td style="text-align:center">主键</td>
</tr>
<tr>
<td style="text-align:center">shop_id</td>
<td style="text-align:center">bigint</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">商户id</td>
</tr>
<tr>
<td style="text-align:center">user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">用户id</td>
</tr>
<tr>
<td style="text-align:center">title</td>
<td style="text-align:center">varchar(255)</td>
<td style="text-align:center">utf8mb4_unicode_ci</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">标题</td>
</tr>
<tr>
<td style="text-align:center">images</td>
<td style="text-align:center">varchar(2048)</td>
<td style="text-align:center">utf8mb4_general_ci</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">探店的照片，最多9张，多张以&quot;,&quot;隔开</td>
</tr>
<tr>
<td style="text-align:center">content</td>
<td style="text-align:center">varchar(2048)</td>
<td style="text-align:center">utf8mb4_unicode_ci</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">探店的文字描述</td>
</tr>
<tr>
<td style="text-align:center">liked</td>
<td style="text-align:center">int unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">0</td>
<td style="text-align:center"></td>
<td style="text-align:center">点赞数量</td>
</tr>
<tr>
<td style="text-align:center">comments</td>
<td style="text-align:center">int unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">评论数量</td>
</tr>
<tr>
<td style="text-align:center">create_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">创建时间</td>
</tr>
<tr>
<td style="text-align:center">update_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED on update CURRENT_TIMESTAM</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<ul>
<li>对应的实体类，数据表中并没有用户头像和用户昵称，但是对应的实体类里却有，这是因为使用了<code>@TableField(exist = false)</code> 用来解决实体类中有的属性但是数据表中没有的字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Blog</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商户id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long shopId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户图标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户姓名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否点赞过了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isLike;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 探店的照片，最多9张，多张以&quot;,&quot;隔开</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String images;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 探店的文字描述</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 点赞数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer liked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 评论数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer comments;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取登录用户</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// 保存探店博文</span></span><br><span class="line">    blogService.save(blog);</span><br><span class="line">    <span class="comment">// 返回id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>上传图片的代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">uploadImage</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取原始文件名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> image.getOriginalFilename();</span><br><span class="line">        <span class="comment">// 生成新文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> createNewFileName(originalFilename);</span><br><span class="line">        <span class="comment">// 保存文件</span></span><br><span class="line">        image.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));</span><br><span class="line">        <span class="comment">// 返回结果</span></span><br><span class="line">        log.debug(<span class="string">&quot;文件上传成功，&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(fileName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;文件上传失败&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：这里我们需要修改<code>SystemConstants.IMAGE_UPLOAD_DIR</code> 为自己图片所在的地址，在实际开发中图片一般会放在nginx上或者是云存储上。</p>
<h3 id="查看探店笔记">查看探店笔记</h3>
<ul>
<li>需求：点击首页的探店笔记，会进入详情页面，我们现在需要实现页面的查询接口</li>
<li>随便点击一张图片，查看发送的请求</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/6">http://localhost:8080/api/blog/6</a><br>
请求方法: GET</p>
</blockquote>
<ul>
<li>看样子是<code>BlogController</code>下的方法，请求方式为GET，那我们直接来编写对应的方法</li>
</ul>
<p>业务逻辑我们要写在Service层，Controller层只调用</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">java</span></span><br><span class="line">@<span class="selector-tag">GetMapping</span>(<span class="string">&quot;/&#123;id&#125;&quot;</span>)</span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">Result</span> <span class="selector-tag">queryById</span>(<span class="variable">@PathVariable</span> Integer id)&#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">blogService</span><span class="selector-class">.queryById</span>(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Service类中创建对应方法之后，在Impl类中实现，我们查看用户探店笔记的时候，需要额外设置用户名和其头像，由于设置用户信息这个操作比较通用，所以这里封装成了一个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="keyword">if</span> (blog == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;评价不存在或已被删除&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    queryBlogUser(blog);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">queryBlogUser</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">    blog.setName(user.getNickName());</span><br><span class="line">    blog.setIcon(user.getIcon());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们顺手将<code>queryHotBlog</code>也修改一下，原始代码将业务逻辑写到了Controller中，修改后的完整代码如下</li>
</ul>
<p>BlogController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取登录用户</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        blog.setUserId(user.getId());</span><br><span class="line">        <span class="comment">// 保存探店博文</span></span><br><span class="line">        blogService.save(blog);</span><br><span class="line">        <span class="comment">// 返回id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/like/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// 修改点赞数量</span></span><br><span class="line">        blogService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/of/me&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryMyBlog</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取登录用户</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        <span class="comment">// 根据用户查询</span></span><br><span class="line">        Page&lt;Blog&gt; page = blogService.query()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, user.getId()).page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// 获取当前页数据</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hot&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryHotBlog(current);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;BlogMapper, Blog&gt; <span class="keyword">implements</span> <span class="title class_">IBlogService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据用户查询</span></span><br><span class="line">        Page&lt;Blog&gt; page = query()</span><br><span class="line">                .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// 获取当前页数据</span></span><br><span class="line">        List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">        <span class="comment">// 查询用户</span></span><br><span class="line">        records.forEach(<span class="built_in">this</span>::queryBlogUser);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line">        <span class="keyword">if</span> (blog == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;评价不存在或已被删除&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">queryBlogUser</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">        blog.setName(user.getNickName());</span><br><span class="line">        blog.setIcon(user.getIcon());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="点赞功能">点赞功能</h3>
<ul>
<li>点击点赞按钮，查看发送的请求</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/like/4">http://localhost:8080/api/blog/like/4</a><br>
请求方法: PUT</p>
</blockquote>
<ul>
<li>看样子是BlogController中的like方法，源码如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/like/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 修改点赞数量</span></span><br><span class="line">    blogService.update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>问题分析：这种方式会导致一个用户无限点赞，明显是不合理的</li>
<li>造成这个问题的原因是，我们现在的逻辑，发起请求只是给数据库+1，所以才会出现这个问题</li>
<li>需求
<ol>
<li>同一个用户只能对同一篇笔记点赞一次，再次点击则取消点赞</li>
<li>如果当前用户已经点赞，则点赞按钮高亮显示（前端已实现，判断字段Blog类的isLike属性）</li>
</ol>
</li>
<li>实现步骤
<ol>
<li>修改点赞功能，利用Redis中的set集合来判断是否点赞过，未点赞则点赞数<code>+1</code>，已点赞则点赞数<code>-1</code></li>
<li>修改根据id查询的业务，判断当前登录用户是否点赞过，赋值给isLike字段</li>
<li>修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段</li>
</ol>
</li>
<li>具体实现</li>
</ul>
<p>业务逻辑写在Service层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/like/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.likeBlog(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 获取当前用户信息</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. 如果当前用户未点赞，则点赞数 +1，同时将用户加入set集合</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLiked</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    <span class="keyword">if</span> (BooleanUtil.isFalse(isLiked)) &#123;</span><br><span class="line">        <span class="comment">//点赞数 +1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//将用户加入set集合</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//3. 如果当前用户已点赞，则取消点赞，将用户从set集合中移除</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//点赞数 -1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">if</span> (success)&#123;</span><br><span class="line">            <span class="comment">//从set集合移除</span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改完毕之后，页面上还不能立即显示点赞完毕的后果，我们还需要修改查询Blog业务，判断Blog是否被当前用户点赞过</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据用户查询</span></span><br><span class="line">    Page&lt;Blog&gt; page = query()</span><br><span class="line">            .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">            .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">    <span class="comment">// 获取当前页数据</span></span><br><span class="line">    List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">    <span class="comment">// 查询用户</span></span><br><span class="line">    records.forEach(blog -&gt; &#123;</span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">//追加判断blog是否被当前用户点赞，逻辑封装到isBlogLiked方法中</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="keyword">if</span> (blog == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;评价不存在或已被删除&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    queryBlogUser(blog);</span><br><span class="line">    <span class="comment">//追加判断blog是否被当前用户点赞，逻辑封装到isBlogLiked方法中</span></span><br><span class="line">    isBlogLiked(blog);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isBlogLiked</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 获取当前用户信息</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. 判断当前用户是否点赞</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    <span class="comment">//3. 如果点赞了，则将isLike设置为true</span></span><br><span class="line">    blog.setIsLike(BooleanUtil.isTrue(isMember));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="点赞排行榜">点赞排行榜</h3>
<ul>
<li>当我们点击探店笔记详情页面时，应该按点赞顺序展示点赞用户，比如显示最早点赞的TOP5，形成点赞排行榜，就跟QQ空间发的说说一样，可以看到有哪些人点了赞</li>
<li>之前的点赞是放到Set集合中，但是Set集合又不能排序，所以这个时候，我们就可以改用SortedSet(Zset)</li>
<li>那我们这里顺便就来对比一下这些集合的区别</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">List</th>
<th style="text-align:center">Set</th>
<th style="text-align:center">SortedSet</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">排序方式</td>
<td style="text-align:center">按添加顺序排序</td>
<td style="text-align:center">无法排序</td>
<td style="text-align:center">根据score值排序</td>
</tr>
<tr>
<td style="text-align:center">唯一性</td>
<td style="text-align:center">不唯一</td>
<td style="text-align:center">唯一</td>
<td style="text-align:center">唯一</td>
</tr>
<tr>
<td style="text-align:center">查找方式</td>
<td style="text-align:center">按索引查找或首尾查找</td>
<td style="text-align:center">根据元素查找</td>
<td style="text-align:center">根据元素查找</td>
</tr>
</tbody>
</table>
<ul>
<li>修改BlogServiceImpl<br>
由于ZSet没有isMember方法，所以这里只能通过查询score来判断集合中是否有该元素，如果有该元素，则返回值是对应的score，如果没有该元素，则返回值为null</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 获取当前用户信息</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. 如果当前用户未点赞，则点赞数 +1，同时将用户加入set集合</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">//尝试获取score</span></span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">    <span class="comment">//为null，则表示集合中没有该用户</span></span><br><span class="line">    <span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//点赞数 +1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//将用户加入set集合</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. 如果当前用户已点赞，则取消点赞，将用户从set集合中移除</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//点赞数 -1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            <span class="comment">//从set集合移除</span></span><br><span class="line">            stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Redis的SortedSet（有序集合）默认按照<strong>score升序排列</strong>（从小到大），但可以通过指定参数实现降序排列。以下是关于SortedSet的关键特性和常用API说明，以及代码的解析：</p>
<h3 id="一、SortedSet-核心特性">一、SortedSet 核心特性</h3>
<ol>
<li><strong>唯一性</strong>：成员（member）唯一，score可重复</li>
<li><strong>排序依据</strong>：按score数值排序（默认升序）</li>
<li><strong>时间复杂度</strong>：大多数操作是O(log(N))</li>
</ol>
<h3 id="二、常用-Redis-SortedSet-API（Java-Spring-Data-Redis）">二、常用 Redis SortedSet API（Java Spring Data Redis）</h3>
<p>在Spring Data Redis中，通过<code>opsForZSet()</code>操作SortedSet：</p>
<h4 id="1-添加-更新成员">1. <strong>添加/更新成员</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaBoolean <span class="title function_">add</span><span class="params">(String key, V value, <span class="type">double</span> score)</span>;</span><br><span class="line"><span class="comment">// 示例：添加用户ID为1001，score=当前时间戳</span></span><br><span class="line">stringRedisTemplate.opsForZSet().add(<span class="string">&quot;liked:blog1&quot;</span>, <span class="string">&quot;1001&quot;</span>, System.currentTimeMillis());</span><br></pre></td></tr></table></figure>
<h4 id="2-移除成员">2. <strong>移除成员</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaLong <span class="title function_">remove</span><span class="params">(String key, Object... values)</span>;</span><br><span class="line"><span class="comment">// 示例：移除用户ID为1001</span></span><br><span class="line">stringRedisTemplate.opsForZSet().remove(<span class="string">&quot;liked:blog1&quot;</span>, <span class="string">&quot;1001&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="3-获取成员score">3. <strong>获取成员score</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaDouble <span class="title function_">score</span><span class="params">(String key, Object member)</span>;</span><br><span class="line"><span class="comment">// 示例：检查用户1001是否已点赞</span></span><br><span class="line"><span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(<span class="string">&quot;liked:blog1&quot;</span>, <span class="string">&quot;1001&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="4-按score范围查询（升序）">4. <strong>按score范围查询（升序）</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaSet&lt;V&gt; <span class="title function_">range</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span>;</span><br><span class="line"><span class="comment">// 示例：获取前10个点赞用户（按时间戳升序）</span></span><br><span class="line">Set&lt;String&gt; users = stringRedisTemplate.opsForZSet().range(<span class="string">&quot;liked:blog1&quot;</span>, <span class="number">0</span>, <span class="number">9</span>);</span><br></pre></td></tr></table></figure>
<h4 id="5-按score范围查询（降序）">5. <strong>按score范围查询（降序）</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaSet&lt;V&gt; <span class="title function_">reverseRange</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span>;</span><br><span class="line"><span class="comment">// 示例：获取最新10个点赞用户（按时间戳降序）</span></span><br><span class="line">Set&lt;String&gt; latestUsers = stringRedisTemplate.opsForZSet().reverseRange(<span class="string">&quot;liked:blog1&quot;</span>, <span class="number">0</span>, <span class="number">9</span>);</span><br></pre></td></tr></table></figure>
<h4 id="6-获取排名（升序）">6. <strong>获取排名（升序）</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaLong <span class="title function_">rank</span><span class="params">(String key, Object member)</span>;</span><br><span class="line"><span class="comment">// 示例：用户1001的升序排名（从0开始）</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">rank</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().rank(<span class="string">&quot;liked:blog1&quot;</span>, <span class="string">&quot;1001&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="7-获取排名（降序）">7. <strong>获取排名（降序）</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">reverseRank</span><span class="params">(String key, Object member)</span>;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li><strong>统计成员数量</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JavaLong <span class="title function_">size</span><span class="params">(String key)</span>;  <span class="comment">// 或 zCard(String key)</span></span><br><span class="line">Long <span class="title function_">count</span><span class="params">(String key, <span class="type">double</span> min, <span class="type">double</span> max)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="三、您的代码解析">三、您的代码解析</h3>
<p>您的点赞逻辑是正确的，但需要注意以下几点：</p>
<h4 id="1-SortedSet排序方向">1. <strong>SortedSet排序方向</strong></h4>
<ul>
<li>代码中<code>System.currentTimeMillis()</code>作为score，表示点赞时间戳</li>
<li>默认按升序排列（从旧到新），若需要<strong>展示最新点赞用户</strong>，应使用<code>reverseRange()</code>实现降序</li>
</ul>
<h4 id="2-潜在优化点">2. <strong>潜在优化点</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Java<span class="comment">// 建议添加原子性保护（如分布式锁）</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line"><span class="keyword">if</span> (success) &#123;</span><br><span class="line">    stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-数据一致性">3. <strong>数据一致性</strong></h4>
<ul>
<li>数据库与Redis操作非原子性，极端情况可能不一致</li>
<li>解决方案：异步补偿机制或事务（需权衡性能）</li>
</ul>
<h3 id="四、SortedSet-典型场景">四、SortedSet 典型场景</h3>
<ol>
<li><strong>排行榜</strong>（按分数排序）</li>
<li><strong>延迟队列</strong>（score=到期时间戳）</li>
<li><strong>时间轴</strong>（score=发布时间戳）</li>
</ol>
<p>将时间戳作为score的设计非常适合记录用户点赞时间，并通过<code>reverseRange()</code>快速获取最新点赞列表。</p>
<ul>
<li>同时修改isBlogLiked方法，在原有逻辑上，判断用户是否已登录，登录状态下才会继续判断用户是否点赞</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isBlogLiked</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 获取当前用户信息</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="comment">//当用户未登录时，就不判断了，直接return结束逻辑</span></span><br><span class="line">    <span class="keyword">if</span> (userDTO == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2. 判断当前用户是否点赞</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + blog.getId();</span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userDTO.getId().toString());</span><br><span class="line">    blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>那我们继续来完善显示点赞列表功能，查看浏览器请求，这个请求目前应该是404的，因为我们还没有写，他需要一个list返回值，显示top5点赞的用户</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/likes/4">http://localhost:8080/api/blog/likes/4</a><br>
请求方法: GET</p>
</blockquote>
<ul>
<li>在Controller层中编写对应的方法，点赞查询列表，具体逻辑写到BlogServiceImpl中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogLikes(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>具体逻辑如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">//zrange key 0 4  查询zset中前5个元素</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">//如果是空的(可能没人点赞)，直接返回一个空集合</span></span><br><span class="line">    <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//将ids使用`,`拼接，SQL语句查询出来的结果并不是按照我们期望的方式进行排</span></span><br><span class="line">    <span class="comment">//所以我们需要用order by field来指定排序方式，期望的排序方式就是按照查询出来的id进行排序</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idsStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    <span class="comment">//select * from tb_user where id in (ids[0], ids[1] ...) order by field(id, ids[0], ids[1] ...)</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query().in(<span class="string">&quot;id&quot;</span>, ids)</span><br><span class="line">            .last(<span class="string">&quot;order by field(id,&quot;</span> + idsStr + <span class="string">&quot;)&quot;</span>)</span><br><span class="line">            .list().stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在MySQL中，<code>FIELD()</code> 是一个函数，用于指定自定义排序顺序。当你在SQL中使用 <code>ORDER BY FIELD(id, 5, 3, 1)</code> 时，它会按照 <code>(5, 3, 1)</code> 的顺序对结果集进行排序，而不是按默认的升序或降序排列。这就是为什么需要拼接 <code>idsStr</code> 的原因。</p>
<blockquote>
<h3 id="为什么要拼接-idsStr？">为什么要拼接 <code>idsStr</code>？</h3>
<ol>
<li><strong>默认排序问题</strong>： SQL的 <code>IN</code> 子句（如 <code>WHERE id IN (5, 3, 1)</code>）返回的结果会默认按主键升序排列（如 <code>1, 3, 5</code>），而非传入的 <code>(5, 3, 1)</code> 顺序。这会导致查询结果顺序与Redis中的点赞排名顺序不一致。</li>
<li><strong>保持顺序一致</strong>： Redis的 <code>ZSET</code> 是按分数（点赞数）排序的，查询前5名时得到的ID顺序是排名顺序（如 <code>5, 3, 1</code>）。为了让数据库结果与这个顺序一致，需要通过 <code>ORDER BY FIELD(id, 5, 3, 1)</code> 强制指定排序规则。</li>
</ol>
</blockquote>
<p>这里出问题了</p>
<p>代码中 <strong>ZSet 的 score 存储的是用户点赞的时间戳</strong>，而 <code>queryBlogLikes</code> 方法却试图将 ZSet 中的前5个元素当作 <strong>点赞数的 Top5</strong>，这会导致逻辑错误。</p>
<h3 id="1-likeBlog-方法的作用"><strong>1. <code>likeBlog</code> 方法的作用</strong></h3>
<ul>
<li><strong>目的</strong>：用户点赞/取消点赞，记录用户行为。</li>
<li>ZSet 的用途：
<ul>
<li><strong>Key</strong>: <code>BLOG_LIKED_KEY + id</code>，记录某篇博客的点赞用户。</li>
<li><strong>Value</strong>: 用户ID。</li>
<li><strong>Score</strong>: 用户点赞的时间戳（<code>System.currentTimeMillis()</code>）。</li>
</ul>
</li>
<li>逻辑：
<ul>
<li>用户首次点赞时，数据库的 <code>liked</code> 字段 +1，并将用户ID和时间戳存入 ZSet。</li>
<li>用户取消点赞时，数据库的 <code>liked</code> 字段 -1，并从 ZSet 中移除用户ID。</li>
</ul>
</li>
</ul>
<h3 id="2-queryBlogLikes-方法的矛盾"><strong>2. <code>queryBlogLikes</code> 方法的矛盾</strong></h3>
<ul>
<li><strong>目标</strong>：查询某篇博客的点赞数前5的用户。</li>
<li>问题：
<ul>
<li>如果 ZSet 的 score 是时间戳，<code>range(key, 0, 4)</code> 会取出 <strong>时间戳最小的前5个用户</strong>（最早点赞的5人），而不是点赞数最多的用户。</li>
<li>数据库的 <code>liked</code> 字段是总点赞数，但 ZSet 中存储的是用户ID和时间戳，<strong>二者没有直接关联</strong>。</li>
</ul>
</li>
</ul>
<h3 id="3-根本问题：数据结构设计错误"><strong>3. 根本问题：数据结构设计错误</strong></h3>
<ul>
<li>ZSet 的作用：
<ul>
<li>如果目标是记录 <strong>哪些用户点过赞</strong>，ZSet 的 score 可以是时间戳，但此时无法统计每个用户的点赞次数。</li>
<li>如果目标是统计 <strong>每个用户的点赞次数</strong>，ZSet 的 score 应是用户的累计点赞次数。</li>
</ul>
</li>
<li>这里的的代码矛盾点：
<ul>
<li><code>likeBlog</code> 用 ZSet 记录用户点赞时间，但 <code>queryBlogLikes</code> 却试图用它查询 Top5 用户，逻辑不匹配。</li>
</ul>
</li>
</ul>
<h3 id="正确设计方案"><strong>正确设计方案</strong></h3>
<h4 id="方案一：用-ZSet-统计用户点赞次数"><strong>方案一：用 ZSet 统计用户点赞次数</strong></h4>
<ul>
<li>
<p>数据结构</p>
<p>：</p>
<ul>
<li>Key: <code>BLOG_LIKED_KEY + id</code></li>
<li>Value: 用户ID</li>
<li>Score: 该用户对这篇博客的累计点赞次数（每次点赞 +1，取消 -1）。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// likeBlog 方法中修改 score 逻辑</span></span><br><span class="line"><span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="comment">// 用户首次点赞，score 初始化为 1</span></span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key, userId.toString(), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="comment">// 用户取消点赞，score -1</span></span><br><span class="line">        stringRedisTemplate.opsForZSet().incrementScore(key, userId.toString(), -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>查询 Top5</strong>： 使用 <code>reverseRange</code> 按 score 降序获取前5名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().reverseRange(key, <span class="number">0</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<h4 id="方案二：用-ZSet-记录用户点赞时间-Hash-统计点赞次数"><strong>方案二：用 ZSet 记录用户点赞时间 + Hash 统计点赞次数</strong></h4>
<ul>
<li>数据结构：
<ul>
<li><strong>ZSet</strong>：记录用户点赞时间（Key: <code>BLOG_LIKED_TIME:&#123;id&#125;</code>, Value: 用户ID, Score: 时间戳）。</li>
<li><strong>Hash</strong>：记录用户累计点赞次数（Key: <code>BLOG_LIKED_COUNT:&#123;id&#125;</code>, Field: 用户ID, Value: 点赞次数）。</li>
</ul>
</li>
<li><strong>代码修改</strong>：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点赞逻辑</span></span><br><span class="line"><span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="comment">// 记录时间戳到 ZSet</span></span><br><span class="line">        stringRedisTemplate.opsForZSet().add(timeKey, userId.toString(), System.currentTimeMillis());</span><br><span class="line">        <span class="comment">// 记录点赞次数到 Hash</span></span><br><span class="line">        stringRedisTemplate.opsForHash().increment(countKey, userId.toString(), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="comment">// 移除 ZSet 中的用户</span></span><br><span class="line">        stringRedisTemplate.opsForZSet().remove(timeKey, userId.toString());</span><br><span class="line">        <span class="comment">// 减少 Hash 中的点赞次数</span></span><br><span class="line">        stringRedisTemplate.opsForHash().increment(countKey, userId.toString(), -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>查询 Top5</strong>： 从 Hash 中获取所有用户的点赞次数，排序后取前5名。</li>
</ul>
<h2 id="好友关注">好友关注</h2>
<h3 id="关注和取消关注">关注和取消关注</h3>
<ul>
<li>当我们进入到笔记详情页面时，会发送一个请求，判断当前登录用户是否关注了笔记博主</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/follow/or/not/2">http://localhost:8080/api/follow/or/not/2</a><br>
请求方法: GET</p>
</blockquote>
<ul>
<li>当我们点击关注按钮时，会发送一个请求，实现关注/取关</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/follow/2/true">http://localhost:8080/api/follow/2/true</a><br>
请求方法: PUT</p>
</blockquote>
<ul>
<li>关注是User之间的关系，是博主与粉丝的关系，数据库中有一张tb_follow表来标示</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">bigint</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">auto_increment</td>
<td style="text-align:center">主键</td>
</tr>
<tr>
<td style="text-align:center">user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">用户id</td>
</tr>
<tr>
<td style="text-align:center">follow_user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">关联的用户id</td>
</tr>
<tr>
<td style="text-align:center">create_time</td>
<td style="text-align:center">timestamp</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">CURRENT_TIMESTAMP</td>
<td style="text-align:center">DEFAULT_GENERATED</td>
<td style="text-align:center">创建时间</td>
</tr>
</tbody>
</table>
<ul>
<li>对应的实体类如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Follow</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关联的用户id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long followUserId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>那我们现在来Controller层中编写对应的两个方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IFollowService followService;</span><br><span class="line">    <span class="comment">//判断当前用户是否关注了该博主</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> followService.isFollow(followUserId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//实现取关/关注</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class="meta">@PathVariable(&quot;isFollow&quot;)</span> Boolean isFellow)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> followService.follow(followUserId,isFellow);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>具体的业务逻辑我们还是放在FellowServiceImpl中来编写</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FollowMapper, Follow&gt; <span class="keyword">implements</span> <span class="title class_">IFollowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="comment">//获取当前登录的userId</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        LambdaQueryWrapper&lt;Follow&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//查询当前用户是否关注了该笔记的博主</span></span><br><span class="line">        queryWrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId);</span><br><span class="line">        <span class="comment">//只查询一个count就行了</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count(queryWrapper);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFellow)</span> &#123;</span><br><span class="line">        <span class="comment">//获取当前用户id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//判断是否关注</span></span><br><span class="line">        <span class="keyword">if</span> (isFellow) &#123;</span><br><span class="line">            <span class="comment">//关注，则将信息保存到数据库</span></span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            save(follow);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//取关，则将数据从数据库中移除</span></span><br><span class="line">            LambdaQueryWrapper&lt;Follow&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId);</span><br><span class="line">            remove(queryWrapper);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="共同关注">共同关注</h3>
<ul>
<li>
<p>点击用户头像，进入到用户详情页，可以查看用户发布的笔记，和共同关注列表</p>
</li>
<li>
<p>但现在我们还没写具体的业务逻辑，所以现在暂时看不到数据</p>
</li>
<li>
<p>检测NetWork选项卡，查看发送的请求</p>
<ul>
<li>查询用户信息</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/user/2">http://localhost:8080/api/user/2</a><br>
请求方法: GET</p>
</blockquote>
<ul>
<li>查看共同关注</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/follow/common/undefined">http://localhost:8080/api/follow/common/undefined</a><br>
请求方法: GET</p>
</blockquote>
</li>
<li>
<p>编写<code>查询用户信息</code>方法</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long userId)</span> &#123;</span><br><span class="line">    <span class="comment">// 查询详情</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有详情，应该是第一次查看详情</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">    <span class="comment">// 返回</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>编写<code>查询用户笔记</code>方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@GetMapping(&quot;/of/user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogByUserId</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current, <span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;Blog&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(Blog::getUserId, id);</span><br><span class="line">        Page&lt;Blog&gt; pageInfo = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE);</span><br><span class="line">        blogService.page(pageInfo, queryWrapper);</span><br><span class="line">        List&lt;Blog&gt; records = pageInfo.getRecords();</span><br><span class="line">        <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//下面这是老师的代码，个人感觉我的可读性更高[doge]</span></span><br><span class="line"><span class="comment">// BlogController  根据id查询博主的探店笔记</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/of/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogByUserId</span><span class="params">(</span></span><br><span class="line"><span class="params">		<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">		<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">	<span class="comment">// 根据用户查询</span></span><br><span class="line">	Page&lt;Blog&gt; page = blogService.query()</span><br><span class="line">			.eq(<span class="string">&quot;user_id&quot;</span>, id).page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">	<span class="comment">// 获取当前页数据</span></span><br><span class="line">	List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">	<span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接下来我们来看看怎么实现共同关注</li>
</ul>
<p>需求：利用Redis中恰当的数据结构，实现共同关注功能，在博主个人页面展示出当前用户与博主的共同关注</p>
<ul>
<li>实现方式当然是我们之前学过的set集合，在set集合中，有交集并集补集的api，可以把二者关注的人放入到set集合中，然后通过api查询两个set集合的交集</li>
<li>那我们就得先修改我们之前的关注逻辑，在关注博主的同时，需要将数据放到set集合中，方便后期我们实现共同关注，当取消关注时，也需要将数据从set集合中删除</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFellow)</span> &#123;</span><br><span class="line">    <span class="comment">//获取当前用户id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">//判断是否关注</span></span><br><span class="line">    <span class="keyword">if</span> (isFellow) &#123;</span><br><span class="line">        <span class="comment">//关注，则将信息保存到数据库</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="comment">//如果保存成功</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="comment">//则将数据也写入Redis</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//取关，则将数据从数据库中移除</span></span><br><span class="line">        LambdaQueryWrapper&lt;Follow&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId);</span><br><span class="line">        <span class="comment">//如果取关成功</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> remove(queryWrapper);</span><br><span class="line">        <span class="comment">//则将数据也从Redis中移除</span></span><br><span class="line">        <span class="keyword">if</span> (success)&#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key,followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>那么接下来，我们实现共同关注代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/common/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> followService.followCommons(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//获取当前用户id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key1</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">//对当前用户和博主用户的关注列表取交集</span></span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key1, key2);</span><br><span class="line">    <span class="keyword">if</span> (intersect == <span class="literal">null</span> || intersect.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">//无交集就返回个空集合</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将结果转为list</span></span><br><span class="line">    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//之后根据ids去查询共同关注的用户，封装成UserDto再返回</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.listByIds(ids).stream().map(user -&gt;</span><br><span class="line">            BeanUtil.copyProperties(user, UserDTO.class)).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Feed流实现方案">Feed流实现方案</h3>
<ul>
<li>
<p>当我们关注了用户之后，这个用户发布了动态，那我们应该把这些数据推送给用户，这个需求，我们又称其为Feed流，关注推送也叫作Feed流，直译为投喂，为用户提供沉浸式体验，通过无限下拉刷新获取新的信息，</p>
</li>
<li>
<p>对于传统的模式内容检索：用户需要主动通过搜索引擎或者是其他方式去查找想看的内容</p>
</li>
<li>
<p>对于新型Feed流的效果：系统分析用户到底想看什么，然后直接把内容推送给用户，从而使用户能更加节约时间，不用去主动搜素</p>
</li>
<li>
<p>Feed流的实现有两种模式</p>
<ol>
<li>Timeline：不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注(B站关注的up，朋友圈等)
<ul>
<li>优点：信息全面，不会有缺失，并且实现也相对简单</li>
<li>缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低</li>
</ul>
</li>
<li>智能排序：利用智能算法屏蔽掉违规的、用户不感兴趣的内容，推送用户感兴趣的信息来吸引用户
<ul>
<li>优点：投喂用户感兴趣的信息，用户粘度很高，容易沉迷</li>
<li>缺点：如果算法不精准，可能会起到反作用（给你推的你都不爱看）</li>
</ul>
</li>
</ol>
</li>
<li>
<p>那我们这里针对好友的操作，采用的是Timeline方式，只需要拿到我们关注用户的信息，然后按照时间排序即可</p>
</li>
<li>
<p>采用Timeline模式，有三种具体的实现方案</p>
<ol>
<li>拉模式</li>
<li>推模式</li>
<li>推拉结合</li>
</ol>
</li>
<li>
<pre><code>拉模式：也叫读扩散
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 该模式的核心含义是：当张三和李四、王五发了消息之后，都会保存到自己的发件箱中，如果赵六要读取消息，那么他会读取他自己的收件箱，此时系统会从他关注的人群中，将他关注人的信息全都进行拉取，然后进行排序</span><br><span class="line">  - 优点：比较节约空间，因为赵六在读取信息时，并没有重复读取，并且读取完之后，可以将他的收件箱清除</span><br><span class="line">  - 缺点：有延迟，当用户读取数据时，才会去关注的人的时发件箱中拉取信息，假设该用户关注了海量用户，那么此时就会拉取很多信息，对服务器压力巨大</span><br><span class="line">    [![img](data:image/gif;<span class="built_in">base64</span>,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)](https://pic1.imgdb.cn/item/6363826516f2c2beb1992291.jpg)</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  推模式：也叫写扩散</span><br></pre></td></tr></table></figure>

- 推模式是没有写邮箱的，当张三写了一个内容，此时会主动把张三写的内容发送到它粉丝的收件箱中，假设此时李四再来读取，就不用再去临时拉取了
- 优点：时效快，不用临时拉取
- 缺点：内存压力大，假设一个大V发了一个动态，很多人关注他，那么就会写很多份数据到粉丝那边去
  [![img](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)](https://pic1.imgdb.cn/item/636383e816f2c2beb1a0ab75.jpg)

</code></pre>
</li>
<li>
<pre><code>推拉结合：页脚读写混合，兼具推和拉两种模式的优点
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  推拉模式是一个折中的方案，站在发件人这一边，如果是普通人，那么我们采用写扩散的方式，直接把数据写入到他的粉丝收件箱中，因为普通人的粉丝数量较少，所以这样不会产生太大压力。但如果是大V，那么他是直接将数据写入一份到发件箱中去，在直接写一份到活跃粉丝的收件箱中，站在收件人这边来看，如果是活跃粉丝，那么大V和普通人发的都会写到自己的收件箱里，但如果是普通粉丝，由于上线不是很频繁，所以等他们上线的时候，再从发件箱中去拉取信息。</span><br><span class="line"></span><br><span class="line"><span class="section">### 推送到粉丝收件箱</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 需求：</span><br><span class="line"><span class="bullet">  1.</span> 修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱</span><br><span class="line"><span class="bullet">  2.</span> 收件箱满足可以根据时间戳排序，必须使用Redis的数据结构实现</span><br><span class="line"><span class="bullet">  3.</span> 查询收件箱数据时，课实现分页查询</span><br><span class="line"><span class="bullet">-</span> Feed流中的数据会不断更新，所以数据的角标也会不断变化，所以我们不能使用传统的分页模式</span><br><span class="line"><span class="bullet">-</span> 假设在t1时刻，我们取读取第一页，此时page = 1，size = 5，那么我们拿到的就是<span class="code">`10~6`</span>这几条记录，假设t2时刻有发布了一条新纪录，那么在t3时刻，我们来读取第二页，此时page = 2，size = 5，那么此时读取的数据是从6开始的，读到的是<span class="code">`6~2`</span>，那么我们就读到了重复的数据，所以我们要使用Feed流的分页，不能使用传统的分页</span><br><span class="line">  </span><br><span class="line"><span class="bullet">-</span> Feed流的滚动分页</span><br><span class="line"><span class="bullet">  -</span> 我们需要记录每次操作的最后一条，然后从这个位置去开始读数据</span><br><span class="line"><span class="bullet">  -</span> 举个例子：我们从t1时刻开始，拿到第一页数据，拿到了<span class="code">`10~6`</span>，然后记录下当前最后一次读取的记录，就是6，t2时刻发布了新纪录，此时这个11在最上面，但不会影响我们之前拿到的6，此时t3时刻来读取第二页，第二页读数据的时候，从<span class="code">`6-1=5`</span>开始读，这样就拿到了<span class="code">`5~1`</span>的记录。我们在这个地方可以使用SortedSet来做，使用时间戳来充当表中的<span class="code">`1~10`</span></span><br><span class="line">  </span><br><span class="line"><span class="bullet">-</span> 核心思路：我们保存完探店笔记后，获取当前用户的粉丝列表，然后将数据推送给粉丝</span><br><span class="line"><span class="bullet">-</span> 那现在我们就需要修改保存笔记的方法</span><br><span class="line"></span><br><span class="line"><span class="code">```java</span></span><br><span class="line"><span class="code">@Override</span></span><br><span class="line"><span class="code">public Result saveBlog(Blog blog) &#123;</span></span><br><span class="line"><span class="code">    // 获取登录用户</span></span><br><span class="line"><span class="code">    UserDTO user = UserHolder.getUser();</span></span><br><span class="line"><span class="code">    blog.setUserId(user.getId());</span></span><br><span class="line"><span class="code">    // 保存探店博文</span></span><br><span class="line"><span class="code">    save(blog);</span></span><br><span class="line"><span class="code">    // 条件构造器</span></span><br><span class="line"><span class="code">    LambdaQueryWrapper&lt;Follow&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span></span><br><span class="line"><span class="code">    // 从follow表最中，查找当前用户的粉丝  select * from follow where follow_user_id = user_id</span></span><br><span class="line"><span class="code">    queryWrapper.eq(Follow::getFollowUserId, user.getId());</span></span><br><span class="line"><span class="code">    //获取当前用户的粉丝</span></span><br><span class="line"><span class="code">    List&lt;Follow&gt; follows = followService.list(queryWrapper);</span></span><br><span class="line"><span class="code">    for (Follow follow : follows) &#123;</span></span><br><span class="line"><span class="code">        Long userId = follow.getUserId();</span></span><br><span class="line"><span class="code">        String key = FEED_KEY + userId;</span></span><br><span class="line"><span class="code">        //推送数据</span></span><br><span class="line"><span class="code">        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    // 返回id</span></span><br><span class="line"><span class="code">    return Result.ok(blog.getId());</span></span><br><span class="line"><span class="code">&#125;</span></span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
<h3 id="实现分页查询收件箱">实现分页查询收件箱</h3>
<ul>
<li>需求：在个人主页的<code>关注栏</code>中，查询并展示推送的Blog信息</li>
<li>具体步骤如下
<ol>
<li>每次查询完成之后，我们要分析出查询出的最小时间戳，这个值会作为下一次的查询条件</li>
<li>我们需要找到与上一次查询相同的查询个数，并作为偏移量，下次查询的时候，跳过这些查询过的数据，拿到我们需要的数据（例如时间戳8 6 6 5 5 4，我们每次查询3个，第一次是8 6 6，此时最小时间戳是6，如果不设置偏移量，会从第一个6之后开始查询，那么查询到的就是6 5 5，而不是5 5 4，如果这里说的不清楚，那就看后续的代码）</li>
</ol>
</li>
<li>综上：我们的请求参数中需要携带lastId和offset，即上一次查询时的最小时间戳和偏移量，这两个参数</li>
<li>编写一个通用的实体类，不一定只对blog进行分页查询，这里用泛型做一个通用的分页查询，list是封装返回的结果，minTime是记录的最小时间戳，offset是记录偏移量</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScrollResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Long minTime;</span><br><span class="line">    <span class="keyword">private</span> Integer offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>点击个人主页中的<code>关注</code>栏，查看发送的请求</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/blog/of/follow?&amp;lastId=1667472294526">http://localhost:8080/api/blog/of/follow?&amp;lastId=1667472294526</a><br>
请求方法: GET</p>
</blockquote>
<ul>
<li>在BlogController中创建对应的方法，具体实现去ServiceImpl中完成</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(<span class="meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="meta">@RequestParam(value = &quot;offset&quot;,defaultValue = &quot;0&quot;)</span> Integer offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogOfFollow(max,offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 获取当前用户</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. 查询该用户收件箱（之前我们存的key是固定前缀 + 粉丝id），所以根据当前用户id就可以查询是否有关注的人发了笔记</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typeTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">            .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">//3. 非空判断</span></span><br><span class="line">    <span class="keyword">if</span> (typeTuples == <span class="literal">null</span> || typeTuples.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4. 解析数据，blogId、minTime（时间戳）、offset，这里指定创建的list大小，可以略微提高效率，因为我们知道这个list就得是这么大</span></span><br><span class="line">    ArrayList&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typeTuples.size());</span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; typeTuple : typeTuples) &#123;</span><br><span class="line">        <span class="comment">//4.1 获取id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> typeTuple.getValue();</span><br><span class="line">        ids.add(Long.valueOf(id));</span><br><span class="line">        <span class="comment">//4.2 获取score（时间戳）</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> typeTuple.getScore().longValue();</span><br><span class="line">        <span class="keyword">if</span> (time == minTime)&#123;</span><br><span class="line">            os++;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            minTime = time;</span><br><span class="line">            os = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//解决SQL的in不能排序问题，手动指定排序为传入的ids</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idsStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="comment">//5. 根据id查询blog</span></span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idsStr + <span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">    <span class="keyword">for</span> (Blog blog : blogs) &#123;</span><br><span class="line">        <span class="comment">//5.1 查询发布该blog的用户信息</span></span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">//5.2 查询当前用户是否给该blog点过赞</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. 封装结果并返回</span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">scrollResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">    scrollResult.setList(blogs);</span><br><span class="line">    scrollResult.setOffset(os);</span><br><span class="line">    scrollResult.setMinTime(minTime);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(scrollResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看还不太懂 滚动分页查询是如何实现的</p>
<p><strong>滚动查询：每一次查询都记住上一次查询的最小值是谁，将最小值作为下一次的最大值，这样就能避免重复查询</strong></p>
<p>因为新发的文章肯定时间戳就大 我们是逆序查的,这样确保能查到最新的 ,那么每次分页查完之后我们都把其中最小的时间戳记住,然后让最小的时间戳作为下一次查询的最大值</p>
<p><strong>从有序集合中按分数从高到低返回指定范围内的成员</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]</span><br></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ZREVRANGEBYSCORE</span> z1 <span class="number">1000</span> <span class="number">0</span> WITHSCORES LIMIT <span class="number">0</span> <span class="number">3</span></span><br><span class="line"><span class="attribute">z1</span>: 有序集合的键名。</span><br><span class="line"><span class="attribute">1000</span> <span class="number">0</span>: 分数范围，表示 max=<span class="number">1000</span>, min=<span class="number">0</span>（从高分到低分筛选分数在 <span class="number">0</span> ≤ score ≤ <span class="number">1000</span> 的成员）。</span><br><span class="line"><span class="attribute">WITHSCORES</span>: 返回结果包含分数。</span><br><span class="line"><span class="attribute">LIMIT</span> <span class="number">0</span> <span class="number">3</span>: 分页参数，表示从第 <span class="number">0</span> 个位置开始，返回 <span class="number">3</span> 个成员。</span><br></pre></td></tr></table></figure>
<p>此命令会执行以下操作：</p>
<ol>
<li>从有序集合 <code>z1</code> 中筛选分数在 <code>0</code> 到 <code>1000</code> 之间的成员。</li>
<li>按分数<strong>从高到低</strong>排序。</li>
<li>返回前 <code>3</code> 个成员及其分数。</li>
</ol>
<p><strong>示例输出</strong>（假设 <code>z1</code> 中的数据）：</p>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Redis</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;memberA&quot;</span>  <span class="meta"># 分数 <span class="number">1000</span></span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;900&quot;</span>      <span class="meta"># memberA 的分数</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;memberB&quot;</span>  <span class="meta"># 分数 <span class="number">800</span></span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;800&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;memberC&quot;</span>  <span class="meta"># 分数 <span class="number">700</span></span></span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;700&quot;</span></span><br><span class="line">&gt; 这个时候输入: ZADD z1 member910 <span class="number">910</span></span><br><span class="line">&gt; ZREVRANGEBYSCORE z1 <span class="number">700</span> <span class="number">0</span> WITHSCORES <span class="keyword">LIMIT</span> <span class="number">1</span> <span class="number">3</span></span><br><span class="line">会输出:</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;memberD&quot;</span>  <span class="meta">#</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;600&quot;</span>      <span class="meta">#</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;memberE&quot;</span>  <span class="meta">#</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;500&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;memberF&quot;</span>  <span class="meta">#</span></span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;400&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>Redis 版本兼容性：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ZREVRANGEBYSCORE</span></span><br></pre></td></tr></table></figure>
<p>在 Redis 6.2.0 后已废弃，建议改用新语法：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ZRANGE</span> z1 <span class="number">0</span> <span class="number">1000</span> BYSCORE REV WITHSCORES LIMIT <span class="number">0</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>分数顺序</strong>：<code>ZREVRANGEBYSCORE</code> 的参数是 <code>max</code> 在前，<code>min</code> 在后，这与升序命令 <code>ZRANGEBYSCORE</code> 相反。</p>
</li>
</ul>
<h3 id="常见用途"><strong>常见用途</strong></h3>
<ul>
<li>获取排行榜中前 N 名（如游戏高分榜）。</li>
<li>按分数倒序分页查询数据。</li>
</ul>
<p>规律：分数最小值和查的数量固定不变。最大值为上一次查询的最小值、偏移量第1次给0，第1次后给在上一次的结果中，与最小值一样的元素的个数。</p>
<p>当分数一致出现问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) <span class="string">&quot;memberA&quot;</span>  # 分数 <span class="number">1000</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;900&quot;</span>      # memberA 的分数</span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;memberB&quot;</span>  # 分数 <span class="number">800</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;800&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;memberC&quot;</span>  # 分数 <span class="number">700</span></span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;700&quot;</span></span><br><span class="line">&gt; 这个时候输入: ZADD z1 member910 <span class="number">910</span></span><br><span class="line">&gt; ZREVRANGEBYSCORE z1 <span class="number">700</span> <span class="number">0</span> WITHSCORES LIMIT <span class="number">1</span> <span class="number">3</span></span><br><span class="line">会输出:</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;memberC&quot;</span>  #</span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;700&quot;</span>      #</span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;memberE&quot;</span>  #</span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;500&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;memberF&quot;</span>  #</span><br><span class="line"><span class="number">6</span>) <span class="string">&quot;400&quot;</span></span><br></pre></td></tr></table></figure>
<p>解决: score范围进行查询，记住最小的时间戳，下次找比这个更小的时间戳。</p>
<p>滚动分页查询参数：</p>
<p>max:第一次：当前时间戳 接下来的：上一次查询的最小值 min:永远是0 offset偏移量:第一次：0 在上一次的结果中，与最小值一样的元素个数 count:3</p>
<p>分数最小值和查的数量固定不变。最大值为上一次查询的最小值、偏移量第1次给0，第1次后给在上一次的结果中，与最小值一样的元素的个数。</p>
<p>假设我们有一个**「时光胶囊」<strong>存储库，每个胶囊上贴着</strong>时间戳标签**（比如2023年、2024年），胶囊里装着你的笔记。所有胶囊按时间从新到旧排列：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"> 时间戳（分数） | 胶囊内容</span></span><br><span class="line"><span class="section">-------------------------</span></span><br><span class="line">2024年        → 胶囊A</span><br><span class="line">2023年        → 胶囊B</span><br><span class="line">2023年        → 胶囊C  </span><br><span class="line">2022年        → 胶囊D</span><br><span class="line">2022年        → 胶囊E</span><br><span class="line">2021年        → 胶囊F</span><br></pre></td></tr></table></figure>
<p>现在你需要按<strong>从新到旧</strong>的顺序，每次取2个胶囊，但遇到同一年份的胶囊要一次性跳过。</p>
<h3 id="2-第一次查询"><strong>2. 第一次查询</strong></h3>
<p><strong>命令</strong>：<code>ZREVRANGEBYSCORE 时光胶囊 9999 0 WITHSCORES LIMIT 0 2</code> （相当于：从最新时间到最旧时间，取前2个）</p>
<p><strong>结果</strong>：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">1</span>) 胶囊A (<span class="number">2024</span>年)</span><br><span class="line"><span class="attribute">2</span>) 胶囊B (<span class="number">2023</span>年)</span><br><span class="line"><span class="attribute">3</span>) 胶囊C (<span class="number">2023</span>年)  ← 这里发现<span class="number">2023</span>年有<span class="number">2</span>个胶囊！</span><br></pre></td></tr></table></figure>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>minTime</strong>（本次最小时间戳）：2023年（因为最后一个是2023年的胶囊C）</li>
<li><strong>offset</strong>（同时间戳数量）：2023年有2个胶囊（B和C），所以offset=2</li>
</ul>
<h3 id="3-第二次查询"><strong>3. 第二次查询</strong></h3>
<p><strong>目标</strong>：跳过所有2023年的胶囊，继续往后取 <strong>命令</strong>：<code>ZREVRANGEBYSCORE 时光胶囊 2023年 0 WITHSCORES LIMIT 2 2</code> （解释：时间≤2023年，跳过前2个，取接下来2个）</p>
<p><strong>结果</strong>：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">1</span>) 胶囊D (<span class="number">2022</span>年)</span><br><span class="line"><span class="attribute">2</span>) 胶囊E (<span class="number">2022</span>年)  ← 发现<span class="number">2022</span>年也有<span class="number">2</span>个！</span><br></pre></td></tr></table></figure>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>minTime</strong>：2022年</li>
<li><strong>offset</strong>：2022年有2个胶囊（D和E），offset=2</li>
</ul>
<h3 id="4-第三次查询"><strong>4. 第三次查询</strong></h3>
<p><strong>命令</strong>：<code>ZREVRANGEBYSCORE 时光胶囊 2022年 0 WITHSCORES LIMIT 2 2</code> （跳过前2个2022年的胶囊，继续往后）</p>
<p><strong>结果</strong>：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>) 胶囊F (<span class="number">2021</span>年)  ← 只剩最后一个</span><br></pre></td></tr></table></figure>
<p><strong>分析</strong>：</p>
<ul>
<li><strong>minTime</strong>：2021年</li>
<li><strong>offset</strong>：2021年只有1个胶囊（F），offset=1</li>
</ul>
<h3 id="5-总结规律"><strong>5. 总结规律</strong></h3>
<ul>
<li><strong>minTime</strong>：每次查询结果的<strong>最后一条时间戳</strong>（不是物理最小，而是逻辑末尾）</li>
<li><strong>offset</strong>：这个时间戳对应的<strong>总条目数</strong>（跳过所有重复项）</li>
<li><strong>下一次查询</strong>：用<code>minTime</code>作为新上限，<code>offset</code>作为跳过量，防止重复</li>
</ul>
<p><strong>类比</strong>：就像翻一本按年份分组的相册，每次翻页必须跳过整组同一年份的照片。</p>
<h3 id="6-回到你的Redis例子"><strong>6. 回到你的Redis例子</strong></h3>
<p>假设数据如下（按分数从高到低）：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">m8</span> → <span class="number">8</span>  </span><br><span class="line"><span class="attribute">g</span>  → <span class="number">7</span>  </span><br><span class="line"><span class="attribute">m7</span> → <span class="number">6</span>  </span><br><span class="line"><span class="attribute">m6</span> → <span class="number">6</span>  </span><br><span class="line"><span class="attribute">m5</span> → <span class="number">5</span>  </span><br><span class="line"><span class="attribute">m4</span> → <span class="number">4</span>  </span><br></pre></td></tr></table></figure>
<p><strong>第一次查询</strong>（LIMIT 0 3）：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">m8</span>(<span class="number">8</span>), g(<span class="number">7</span>), m7(<span class="number">6</span>)  ← 最小分数<span class="number">6</span>，同分有<span class="number">2</span>个（m7和m6）</span><br></pre></td></tr></table></figure>
<p><strong>第二次查询</strong>（LIMIT 2 3）： 跳过前2个（m7和m6），接着取：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">m5</span>(<span class="number">5</span>), <span class="built_in">m4</span>(<span class="number">4</span>), ...   ← 新的最小分数</span><br></pre></td></tr></table></figure>
<h3 id="7-为什么需要这样设计？"><strong>7. 为什么需要这样设计？</strong></h3>
<ul>
<li><strong>避免重复</strong>：如果直接用页码，可能重复返回同分条目</li>
<li><strong>精确分页</strong>：确保每次查询都是全新的数据区间</li>
<li><strong>动态适应</strong>：即使时间戳分布不均匀（比如某天发100条笔记），也能准确跳过</li>
</ul>
<p><img src="https://img.picui.cn/free/2025/03/25/67e2bc4854f0e.png" alt="image-20250325210725483.png"></p>
<p>元组（tuple）是关系数据库中的基本概念，是数据库中的一种数据结构。 在关系数据库中，数据以表格的形式存储，每个表格称为一个关系（relation），而表格中的每一行称为一个元组（tuple）。 元组是关系数据库中的基本单位，它代表了数据库中的一条记录。</p>
<p>ZSetOperations 操作接口 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.hxstrive.com%2Fsubject%2Fspring_data_redis%2F1793.htm">www.hxstrive.com/subject/spr…</a></p>
<p>在 Spring Data Redis 中，可以通过 RedisTemplate 的 opsForZSet() 方法获取，如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZSetOperations&lt;<span class="type">String</span>,<span class="type">String</span>&gt; ops = redisTemplate.<span class="built_in">opsForZSet</span>();</span><br></pre></td></tr></table></figure>
<p>实现滚动分页查询逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span> &#123;</span><br><span class="line">        <span class="comment">//获取当前用户 之后得到它的id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//然后查询收件箱 zrevrangebyscore key max min limit offset count</span></span><br><span class="line">        <span class="comment">//查询出来的有点多 解析数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">                .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//非空判断</span></span><br><span class="line">        <span class="keyword">if</span> (typedTuples == <span class="literal">null</span> ||typedTuples.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.解析数据：blogId、minTime(时间戳)、offset</span></span><br><span class="line">        ArrayList&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        遍历ZSetOperations集合先拿到第一个，然后把它赋值给minTime，然后遍历第二个，又赋值，最后一个一定是这个最小时间戳</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">          offset怎么求 涉及到算法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples)&#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//4.1.获取id</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> tuple.getValue();</span><br><span class="line">            ids.add(Long.valueOf(idStr));</span><br><span class="line">            <span class="comment">//4.2.获取分数(时间戳)</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> tuple.getScore().longValue();</span><br><span class="line">            <span class="keyword">if</span> (time == minTime)&#123;</span><br><span class="line">                os++;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                minTime = time;</span><br><span class="line">                os = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据id查询blog  和上面  根据用户id查询用户差不多</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">        List&lt;Blog&gt; blogs = query()</span><br><span class="line">                .in(<span class="string">&quot;id&quot;</span>,ids).in(<span class="string">&quot;id&quot;</span>, ids)</span><br><span class="line">                .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再补充上一点才完整</span></span><br><span class="line">        <span class="keyword">for</span> (Blog blog : blogs) &#123;</span><br><span class="line">            isBlogLiked(blog);</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(blog.getUserId());</span><br><span class="line">            blog.setName(user.getNickName());</span><br><span class="line">            blog.setIcon(user.getIcon());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装并返回</span></span><br><span class="line">        <span class="type">ScrollResult</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">        r.setList(blogs);</span><br><span class="line">        r.setOffset(os);</span><br><span class="line">        r.setMinTime(minTime);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="附近商户">附近商户</h2>
<h3 id="GEO数据结构的基本用法">GEO数据结构的基本用法</h3>
<ul>
<li>
<p>GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据，常见的命令有</p>
<ul>
<li>
<p>GEOADD：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）</p>
</li>
<li>
<p>命令格式</p>
</li>
</ul>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOADD <span class="built_in">key</span> longitude latitude <span class="built_in">member</span> [longitude latitude <span class="built_in">member</span> …]</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值：添加到sorted set元素的数目，但不包括已更新score的元素</li>
<li>复杂度：每⼀个元素添加是O(log(N)) ，N是sorted set的元素数量</li>
<li>举例</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bash</span></span><br><span class="line"><span class="attribute">GEOADD</span> china <span class="number">13</span>.<span class="number">361389</span> <span class="number">38</span>.<span class="number">115556</span> <span class="string">&quot;shanghai&quot;</span> <span class="number">15</span>.<span class="number">087269</span> <span class="number">37</span>.<span class="number">502669</span> <span class="string">&quot;beijing&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>GEODIST：计算指定的两个点之间的距离并返回</p>
</li>
<li>
<p>命令格式</p>
</li>
</ul>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">GEODIST key member1 member2 [m|<span class="type">km</span>|<span class="type">ft</span>|<span class="type">mi</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>如果两个位置之间的其中⼀个不存在， 那么命令返回空值。</li>
<li>指定单位的参数 unit 必须是以下单位的其中⼀个：
<ul>
<li>m 表示单位为米。</li>
<li>km 表示单位为千米。</li>
<li>mi 表示单位为英⾥。</li>
<li>ft 表示单位为英尺。</li>
</ul>
</li>
<li>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位。</li>
<li>GEODIST 命令在计算距离时会假设地球为完美的球形， 在极限情况下， 这⼀假设最⼤会造成 0.5% 的误差</li>
<li>返回值：计算出的距离会以双精度浮点数的形式被返回。 如果给定的位置元素不存在， 那么命令返回空值</li>
<li>举例</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash</span></span><br><span class="line"><span class="keyword"></span>GEODIST china <span class="keyword">beijing </span><span class="keyword">shanghai </span>km</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>GEOHASH：将指定member的坐标转化为hash字符串形式并返回</p>
</li>
<li>
<p>命令格式</p>
</li>
</ul>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">GEOHASH <span class="built_in">key</span> <span class="built_in">member</span> [<span class="built_in">member</span> …]</span><br></pre></td></tr></table></figure>
<ul>
<li>通常使用表示位置的元素使用不同的技术，使用Geohash位置52点整数编码。由于编码和解码过程中所使用的初始最小和最大坐标不同，编码的编码也不同于标准。此命令返回一个标准的Geohash，在维基百科和geohash.org网站都有相关描述</li>
<li>返回值：一个数组， 数组的每个项都是一个 geohash 。 命令返回的 geohash 的位置与用户给定的位置元素的位置一一对应</li>
<li>复杂度：O(log(N)) for each member requested, where N is the number of elements in the sorted set</li>
<li>举例</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash</span></span><br><span class="line"><span class="keyword"></span>云服务器:<span class="number">0</span>&gt;GEOHASH china <span class="keyword">beijing </span><span class="keyword">shanghai</span></span><br><span class="line"><span class="keyword"></span><span class="number">1</span>) <span class="string">&quot;sqdtr74hyu0&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;sqc8b49rny0&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>GEOPOS：返回指定member的坐标</p>
</li>
<li>
<p>格式：GEOPOS key member [member …]</p>
</li>
<li>
<p>给定一个sorted set表示的空间索引，密集使用 geoadd 命令，它以获得指定成员的坐标往往是有益的。当空间索引填充通过 geoadd 的坐标转换成一个52位Geohash，所以返回的坐标可能不完全以添加元素的，但小的错误可能会出台。</p>
</li>
<li>
<p>因为 GEOPOS 命令接受可变数量的位置元素作为输入， 所以即使用户只给定了一个位置元素， 命令也会返回数组回复</p>
</li>
<li>
<p>返回值：GEOPOS 命令返回一个数组， 数组中的每个项都由两个元素组成： 第一个元素为给定位置元素的经度， 而第二个元素则为给定位置元素的纬度。当给定的位置元素不存在时， 对应的数组项为空值</p>
</li>
<li>
<p>复杂度：O(log(N)) for each member requested, where N is the number of elements in the sorted set</p>
</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash</span></span><br><span class="line"><span class="keyword"></span>云服务器:<span class="number">0</span>&gt;geopos china <span class="keyword">beijing </span><span class="keyword">shanghai</span></span><br><span class="line"><span class="keyword"></span><span class="number">1</span>)  <span class="number">1</span>) <span class="string">&quot;15.08726745843887329&quot;</span></span><br><span class="line">    <span class="number">2</span>) <span class="string">&quot;37.50266842333162032&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>)  <span class="number">1</span>) <span class="string">&quot;13.36138933897018433&quot;</span></span><br><span class="line">    <span class="number">2</span>) <span class="string">&quot;38.11555639549629859&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>GEOGADIUS：指定圆心、半径，找到该园内包含的所有member，并按照与圆心之间的距离排序后返回，<code>6.2之后已废弃</code></p>
</li>
<li>
<p>命令格式</p>
</li>
</ul>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">GEORADIUS key longitude latitude radius m|km|ft|mi <span class="comment">[WITHCOORD]</span> <span class="comment">[WITHDIST]</span> <span class="comment">[WITHHASH]</span> </span><br><span class="line"><span class="comment">[COUNT count <span class="comment">[ANY]</span>]</span> <span class="comment">[ASC|DESC]</span> <span class="comment">[STORE key]</span> <span class="comment">[STOREDIST key]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>范围可以使用以下其中一个单位：
<ul>
<li>m 表示单位为米。</li>
<li>km 表示单位为千米。</li>
<li>mi 表示单位为英里。</li>
<li>ft 表示单位为英尺。</li>
</ul>
</li>
<li>在给定以下可选项时， 命令会返回额外的信息：
<ul>
<li>WITHDIST: 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。</li>
<li>WITHCOORD: 将位置元素的经度和维度也一并返回。</li>
<li>WITHHASH: 以 52 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。 这个选项主要用于底层应用或者调试， 实际中的作用并不大。</li>
</ul>
</li>
<li>命令默认返回未排序的位置元素。 通过以下两个参数， 用户可以指定被返回位置元素的排序方式：
<ul>
<li>ASC: 根据中心的位置， 按照从近到远的方式返回位置元素。</li>
<li>DESC: 根据中心的位置， 按照从远到近的方式返回位置元素。</li>
</ul>
</li>
<li>在默认情况下， GEORADIUS 命令会返回所有匹配的位置元素。 虽然用户可以使用 COUNT 选项去获取前 N 个匹配元素， 但是因为命令在内部可能会需要对所有被匹配的元素进行处理， 所以在对一个非常大的区域进行搜索时， 即使只使用 COUNT 选项去获取少量元素， 命令的执行速度也可能会非常慢。 但是从另一方面来说， 使用 COUNT 选项去减少需要返回的元素数量， 对于减少带宽来说仍然是非常有用的</li>
<li>返回值：
<ul>
<li>在没有给定任何 WITH 选项的情况下， 命令只会返回一个像 [“New York”,”Milan”,”Paris”] 这样的线性（linear）列表。</li>
<li>在指定了 WITHCOORD 、 WITHDIST 、 WITHHASH 等选项的情况下， 命令返回一个二层嵌套数组， 内层的每个子数组就表示一个元素。</li>
<li>在返回嵌套数组时， 子数组的第一个元素总是位置元素的名字。 至于额外的信息， 则会作为子数组的后续元素， 按照以下顺序被返回：
<ul>
<li>以浮点数格式返回的中心与位置元素之间的距离， 单位与用户指定范围时的单位一致。</li>
<li>geohash 整数。</li>
<li>由两个元素组成的坐标，分别为经度和纬度</li>
</ul>
</li>
</ul>
</li>
<li>举例</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line"></span><br><span class="line"><span class="section">云服务器:0&gt;GEORADIUS china 15 37 200 km WITHDIST WITHCOORD</span></span><br><span class="line">1)  1) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    2) <span class="string">&quot;190.4424&quot;</span></span><br><span class="line">    3)  1) <span class="string">&quot;13.36138933897018433&quot;</span></span><br><span class="line">        2) <span class="string">&quot;38.11555639549629859&quot;</span></span><br><span class="line"></span><br><span class="line">2)  1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">    2) <span class="string">&quot;56.4413&quot;</span></span><br><span class="line">    3)  1) <span class="string">&quot;15.08726745843887329&quot;</span></span><br><span class="line">        2) <span class="string">&quot;37.50266842333162032&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">云服务器:0&gt;GEORADIUS china 15 37 200 km WITHDIST</span></span><br><span class="line">1)  1) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    2) <span class="string">&quot;190.4424&quot;</span></span><br><span class="line"></span><br><span class="line">2)  1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">    2) <span class="string">&quot;56.4413&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>GEOSEARCH：在指定范围内搜索member，并按照与制定点之间的距离排序后返回，范围可以使圆形或矩形，6.2的新功能</li>
</ul>
<p>命令格式</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">GEOSEARCH key <span class="comment">[FROMMEMBER member]</span> <span class="comment">[FROMLONLAT longitude latitude]</span> <span class="comment">[BYRADIUS radius m|km|ft|mi]</span> </span><br><span class="line"><span class="comment">[BYBOX width height m|km|ft|mi]</span> <span class="comment">[ASC|DESC]</span> <span class="comment">[COUNT count <span class="comment">[ANY]</span>]</span> <span class="comment">[WITHCOORD]</span> <span class="comment">[WITHDIST]</span> <span class="comment">[WITHHASH]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>举例</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line">云服务器:<span class="number">0</span>&gt;geosearch china FROMLONLAT <span class="number">15</span> <span class="number">37</span> <span class="keyword">BYRADIUS </span><span class="number">200</span> km ASC WITHCOORD WITHDIST</span><br><span class="line"><span class="number">1</span>)  <span class="number">1</span>) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">    <span class="number">2</span>) <span class="string">&quot;56.4413&quot;</span></span><br><span class="line">    <span class="number">3</span>)  <span class="number">1</span>) <span class="string">&quot;15.08726745843887329&quot;</span></span><br><span class="line">        <span class="number">2</span>) <span class="string">&quot;37.50266842333162032&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>)  <span class="number">1</span>) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    <span class="number">2</span>) <span class="string">&quot;190.4424&quot;</span></span><br><span class="line">    <span class="number">3</span>)  <span class="number">1</span>) <span class="string">&quot;13.36138933897018433&quot;</span></span><br><span class="line">        <span class="number">2</span>) <span class="string">&quot;38.11555639549629859&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">云服务器:<span class="number">0</span>&gt;geosearch china FROMLONLAT <span class="number">15</span> <span class="number">37</span> <span class="keyword">BYBOX </span><span class="number">400</span> <span class="number">400</span> km DESC WITHCOORD WITHDIST</span><br><span class="line"><span class="number">1</span>)  <span class="number">1</span>) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    <span class="number">2</span>) <span class="string">&quot;190.4424&quot;</span></span><br><span class="line">    <span class="number">3</span>)  <span class="number">1</span>) <span class="string">&quot;13.36138933897018433&quot;</span></span><br><span class="line">        <span class="number">2</span>) <span class="string">&quot;38.11555639549629859&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>)  <span class="number">1</span>) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">    <span class="number">2</span>) <span class="string">&quot;56.4413&quot;</span></span><br><span class="line">    <span class="number">3</span>)  <span class="built_in">S1</span>) <span class="string">&quot;15.08726745843887329&quot;</span></span><br><span class="line">        <span class="number">2</span>) <span class="string">&quot;37.50266842333162032&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>GEOSEARCHSTORE：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key，也是6.2的新功能</p>
</li>
<li>
<p>命令格式</p>
</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">GEOSEARCHSTORE destination <span class="selector-tag">source</span> <span class="selector-attr">[FROMMEMBER member]</span> <span class="selector-attr">[FROMLONLAT longitude latitude]</span> </span><br><span class="line"><span class="selector-attr">[BYRADIUS radius m|km|ft|mi]</span> <span class="selector-attr">[BYBOX width height m|km|ft|mi]</span> </span><br><span class="line"><span class="selector-attr">[ASC|DESC]</span> <span class="selector-attr">[COUNT count [ANY]</span>] <span class="selector-attr">[STOREDIST]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这个命令和 GEORADIUS 命令一样， 都可以找出位于指定范围内的元素， 但是 GEORADIUSBYMEMBER 的中心点是由给定的位置元素决定的， 而不是像 GEORADIUS 那样， 使用输入的经度和纬度来决定中心点</li>
<li>指定成员的位置被用作查询的中心。</li>
<li>关于 GEORADIUSBYMEMBER 命令的更多信息， 请参考 GEORADIUS 命令的文档</li>
<li>复杂度：O(N+log(M)) where N is the number of elements inside the bounding box of the circular area delimited by center and radius and M is the number of items inside the index</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bash</span></span><br><span class="line"><span class="keyword"></span>云服务器:<span class="number">0</span>&gt;GEORADIUSBYMEMBER china <span class="keyword">beijing </span><span class="number">200</span> km</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;beijing&quot;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="导入店铺数据到GEO">导入店铺数据到GEO</h3>
<ul>
<li>具体场景说明，例如美团/饿了么这种外卖App，你是可以看到商家离你有多远的，那我们现在也要实现这个功能。</li>
<li>我们可以使用GEO来实现该功能，以当前坐标为圆心，同时绑定相同的店家类型type，以及分页信息，把这几个条件插入后台，后台查询出对应的数据再返回</li>
<li>那现在我们要做的就是：将数据库中的数据导入到Redis中去，GEO在Redis中就是一个member和一个经纬度，经纬度对应的就是tb_shop中的x和y，而member，我们用shop_id来存，因为Redis只是一个内存级数据库，如果存海量的数据，还是力不从心，所以我们只存一个id，用的时候再拿id去SQL数据库中查询shop信息</li>
<li>但是此时还有一个问题，我们在redis中没有存储shop_type，无法根据店铺类型来对数据进行筛选，解决办法就是将type_id作为key，存入同一个GEO集合即可</li>
</ul>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
<th>Score</th>
</tr>
</thead>
<tbody>
<tr>
<td>shop:geo:美食</td>
<td>海底捞</td>
<td>40691512240174598</td>
</tr>
<tr>
<td>吉野家</td>
<td>40691519846517915</td>
<td></td>
</tr>
<tr>
<td>shop:geo:KTV</td>
<td>KTV 01</td>
<td>40691165486458787</td>
</tr>
<tr>
<td>KTV 02</td>
<td>40691514154651657</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>代码如下</li>
</ul>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line"><span class="keyword">public</span> <span class="literal">void</span> loadShopData()&#123;</span><br><span class="line">    <span class="comment">//1. 查询所有店铺信息</span></span><br><span class="line">    <span class="built_in">List</span>&lt;Shop&gt; shopList = shopService.<span class="built_in">list</span>();</span><br><span class="line">    <span class="comment">//2. 按照typeId，将店铺进行分组</span></span><br><span class="line">    <span class="built_in">Map</span>&lt;Long, <span class="built_in">List</span>&lt;Shop&gt;&gt; <span class="built_in">map</span> = shopList.stream().collect(Collectors.groupingBy(Shop<span class="type">::getTypeId</span>));</span><br><span class="line">    <span class="comment">//3. 逐个写入Redis</span></span><br><span class="line">    for (<span class="built_in">Map</span>.Entry&lt;Long, <span class="built_in">List</span>&lt;Shop&gt;&gt; entry : <span class="built_in">map</span>.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//3.1 获取类型id</span></span><br><span class="line">        Long typeId = entry.getKey();</span><br><span class="line">        <span class="comment">//3.2 获取同类型店铺的集合</span></span><br><span class="line">        <span class="built_in">List</span>&lt;Shop&gt; shops = entry.getValue();</span><br><span class="line">        <span class="built_in">String</span> key = SHOP_GEO_KEY + typeId;</span><br><span class="line">        for (Shop shop : shops) &#123;</span><br><span class="line">            <span class="comment">//3.3 写入redis GEOADD key 经度 纬度 member</span></span><br><span class="line">            stringRedisTemplate.opsForGeo().add(key,<span class="literal">new</span> Point(shop.getX(),shop.getY()),shop.getId().toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>但是上面的代码不够优雅，是一条一条写入的，效率较低，那我们现在来改进一下，这样只需要写入等同于type_id数量的次数</li>
</ul>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line"><span class="keyword">public</span> <span class="literal">void</span> loadShopData() &#123;</span><br><span class="line">    <span class="built_in">List</span>&lt;Shop&gt; shopList = shopService.<span class="built_in">list</span>();</span><br><span class="line">    <span class="built_in">Map</span>&lt;Long, <span class="built_in">List</span>&lt;Shop&gt;&gt; <span class="built_in">map</span> = shopList.stream().collect(Collectors.groupingBy(Shop<span class="type">::getTypeId</span>));</span><br><span class="line">    for (<span class="built_in">Map</span>.Entry&lt;Long, <span class="built_in">List</span>&lt;Shop&gt;&gt; entry : <span class="built_in">map</span>.entrySet()) &#123;</span><br><span class="line">        Long typeId = entry.getKey();</span><br><span class="line">        <span class="built_in">List</span>&lt;Shop&gt; shops = entry.getValue();</span><br><span class="line">        <span class="built_in">String</span> key = SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="built_in">List</span>&lt;RedisGeoCommands.GeoLocation&lt;<span class="built_in">String</span>&gt;&gt; locations = <span class="literal">new</span> ArrayList&lt;&gt;(shops.size());</span><br><span class="line">        for (Shop shop : shops) &#123;</span><br><span class="line">            <span class="comment">//将当前type的商铺都添加到locations集合中</span></span><br><span class="line">            locations.add(<span class="literal">new</span> RedisGeoCommands.GeoLocation&lt;&gt;(shop.getId().toString(), <span class="literal">new</span> Point(shop.getX(), shop.getY())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//批量写入</span></span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>代码编写完毕，我们启动测试方法，然后去Redis图形化界面中查看是否有对应的数据</li>
</ul>
<h3 id="实现附近商户功能">实现附近商户功能</h3>
<ul>
<li>SpringDataRedis的2.3.9版本并不支持Redis 6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的pom.xml文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">xml</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>点击距离分类，查看发送的请求</li>
</ul>
<blockquote>
<p>请求网址: <a target="_blank" rel="noopener" href="http://localhost:8080/api/shop/of/type?&amp;typeId=1&amp;current=1&amp;x=120.149993&amp;y=30.334229">http://localhost:8080/api/shop/of/type?&amp;typeId=1&amp;current=1&amp;x=120.149993&amp;y=30.334229</a><br>
请求方法: GET</p>
</blockquote>
<ul>
<li>看样子是ShopController中的方法，那我们现在来修改其代码，除了typeId，分页码，我们还需要其坐标</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">java</span></span><br><span class="line">@<span class="selector-tag">GetMapping</span>(<span class="string">&quot;/of/type&quot;</span>)</span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">Result</span> <span class="selector-tag">queryShopByType</span>(</span><br><span class="line">        <span class="variable">@RequestParam</span>(<span class="string">&quot;typeId&quot;</span>) Integer typeId,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value = <span class="string">&quot;current&quot;</span>, defaultValue = <span class="string">&quot;1&quot;</span>) Integer current,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value = <span class="string">&quot;x&quot;</span>, required = false) Double x,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value = <span class="string">&quot;y&quot;</span>, required = false) Double y</span><br><span class="line">) &#123;</span><br><span class="line">   <span class="selector-tag">return</span> <span class="selector-tag">shopService</span><span class="selector-class">.queryShopByType</span>(typeId,current,x,y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>具体业务逻辑依旧是写在ShopServiceImpl中</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result queryShopByType(Integer typeId, Integer current, <span class="keyword">Double</span> x, <span class="keyword">Double</span> y) &#123;</span><br><span class="line">    <span class="comment">//1. 判断是否需要根据距离查询</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span> || y == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 根据类型分页查询</span></span><br><span class="line">        Page&lt;Shop&gt; page = query()</span><br><span class="line">                .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                .page(<span class="keyword">new</span> Page&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">        <span class="comment">// 返回数据</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2. 计算分页查询参数</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">from</span> = (current - <span class="number">1</span>) * SystemConstants.MAX_PAGE_SIZE;</span><br><span class="line">    <span class="keyword">int</span> end = current * SystemConstants.MAX_PAGE_SIZE;</span><br><span class="line">    String key = SHOP_GEO_KEY + typeId;</span><br><span class="line">    <span class="comment">//3. 查询redis、按照距离排序、分页; 结果：shopId、distance</span></span><br><span class="line">    <span class="comment">//GEOSEARCH key FROMLONLAT x y BYRADIUS 5000 m WITHDIST</span></span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo().search(key,</span><br><span class="line">            GeoReference.fromCoordinate(x, y),</span><br><span class="line">            <span class="keyword">new</span> Distance(<span class="number">5000</span>),</span><br><span class="line">            RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end));</span><br><span class="line">    <span class="keyword">if</span> (results == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4. 解析出id</span></span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">    <span class="keyword">if</span> (list.<span class="keyword">size</span>() &lt; <span class="keyword">from</span>) &#123;</span><br><span class="line">        <span class="comment">//起始查询位置大于数据总量，则说明没数据了，返回空集合</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;<span class="keyword">Long</span>&gt; ids = <span class="keyword">new</span> ArrayList&lt;&gt;(list.<span class="keyword">size</span>());</span><br><span class="line">    HashMap&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> HashMap&lt;&gt;(list.<span class="keyword">size</span>());</span><br><span class="line">    list.stream().skip(<span class="keyword">from</span>).forEach(result -&gt; &#123;</span><br><span class="line">        String shopIdStr = result.getContent().getName();</span><br><span class="line">        ids.add(<span class="keyword">Long</span>.valueOf(shopIdStr));</span><br><span class="line">        Distance distance = result.getDistance();</span><br><span class="line">        distanceMap.put(shopIdStr, distance);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//5. 根据id查询shop</span></span><br><span class="line">    String idsStr = StrUtil.<span class="keyword">join</span>(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD( id,&quot;</span> + idsStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">        <span class="comment">//设置shop的举例属性，从distanceMap中根据shopId查询</span></span><br><span class="line">        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. 返回</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>最终效果如下，可以显示出距离<br>
<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6364c8c216f2c2beb16eb996.jpg"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="img"></a></li>
</ul>
<h2 id="用户签到">用户签到</h2>
<h3 id="BitMap功能演示">BitMap功能演示</h3>
<ul>
<li>我们针对签到功能完全可以通过MySQL来完成，例如下面这张表</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Field</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Collation</th>
<th style="text-align:center">Null</th>
<th style="text-align:center">Key</th>
<th style="text-align:center">Default</th>
<th style="text-align:center">Extra</th>
<th style="text-align:center">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">PRI</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">auto_increment</td>
<td style="text-align:center">主键</td>
</tr>
<tr>
<td style="text-align:center">user_id</td>
<td style="text-align:center">bigint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">用户id</td>
</tr>
<tr>
<td style="text-align:center">year</td>
<td style="text-align:center">year</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">签到的年</td>
</tr>
<tr>
<td style="text-align:center">month</td>
<td style="text-align:center">tinyint</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">签到的月</td>
</tr>
<tr>
<td style="text-align:center">date</td>
<td style="text-align:center">date</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">NO</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">签到的日期</td>
</tr>
<tr>
<td style="text-align:center">is_backup</td>
<td style="text-align:center">tinyint unsigned</td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center">YES</td>
<td style="text-align:center"></td>
<td style="text-align:center">(NULL)</td>
<td style="text-align:center"></td>
<td style="text-align:center">是否补签</td>
</tr>
</tbody>
</table>
<ul>
<li>用户签到一次，就是一条记录，假如有1000W用户，平均没人每年签到10次，那这张表一年的数据量就有1亿条</li>
<li>那有没有方法能简化一点呢？我们可以使用二进制位来记录每个月的签到情况，签到记录为1，未签到记录为0</li>
<li>把每一个bit位对应当月的每一天，形成映射关系，用0和1标识业务状态，这种思路就成为位图（BitMap）。这样我们就能用极小的空间，来实现大量数据的表示</li>
<li>Redis中是利用String类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是2^32个bit位</li>
<li>BitMap的操作命令有
<ul>
<li>SETBIT：向指定位置（offset）存入一个0或1</li>
<li>GETBIT：获取指定位置（offset）的bit值</li>
<li>BITCOUNT：统计BitMap中值为1的bit位的数量</li>
<li>BITFIELD：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值</li>
<li>BITFIELD_RO：获取BitMap中bit数组，并以十进制形式返回</li>
<li>BITOP：将多个BitMap的结果做位运算（与、或、异或）</li>
<li>BITPOS：查找bit数组中指定范围内第一个0或1出现的位置</li>
</ul>
</li>
</ul>
<h3 id="实现签到功能">实现签到功能</h3>
<ul>
<li>需求：实现签到接口，将当前用户当天签到信息保存到Redis中</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">请求方式</td>
<td style="text-align:center">Post</td>
</tr>
<tr>
<td style="text-align:center">请求路径</td>
<td style="text-align:center">/user/sign</td>
</tr>
<tr>
<td style="text-align:center">请求参数</td>
<td style="text-align:center">无</td>
</tr>
<tr>
<td style="text-align:center">返回值</td>
<td style="text-align:center">无</td>
</tr>
</tbody>
</table>
<ul>
<li>思路：我们可以把年和月作为BitMap的key，然后保存到一个BitMap中，每次签到就把对应位上的0变成1，只要是1就说明这一天已经签到了，反之则没有签到</li>
<li>由于BitMap底层是基于String数据结构，因此其操作也都封装在字符串相关操作中了</li>
<li>在UserController中编写对应的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/sign&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.sign();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. 获取当前用户</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. 获取日期</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">//3. 拼接key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//4. 获取今天是当月第几天(1~31)</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">//5. 写入Redis  BITSET key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="连续签到统计">连续签到统计</h3>
<ul>
<li>如何获取本月到今天为止的所有签到数据？
<ul>
<li>BITFIELD key GET u[dayOfMonth] 0</li>
</ul>
</li>
<li>如何从后往前遍历每个bit位，获取连续签到天数
<ul>
<li>连续签到天数，就是从末尾往前数，看有多少个1</li>
<li>简单的位运算算法</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>((num &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        count++;</span><br><span class="line">    num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> count;</span><br></pre></td></tr></table></figure>
<p>这段代码是<strong>统计整数二进制表示中，从最低位（右侧）开始连续出现 <code>1</code> 的次数</strong>。就像用探针从右往左扫描二进制位，遇到第一个 <code>0</code> 就停止。</p>
<h3 id="逐帧拆解（以-num-15-为例）"><strong>逐帧拆解（以 num=15 为例）</strong></h3>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">num = 15（二进制 1111）</span><br><span class="line">循环次数 |<span class="string"> 操作                  </span>|<span class="string"> 二进制状态      </span>|<span class="string"> count</span></span><br><span class="line"><span class="string">---------------------------------------------------------</span></span><br><span class="line"><span class="string">初始值  </span>|<span class="string">                       </span>|<span class="string"> 1111           </span>|<span class="string"> 0</span></span><br><span class="line"><span class="string">第1次  </span>|<span class="string"> 检查最后一位是1 → count+1 </span>|<span class="string"> 1111 → 右移成 111 </span>|<span class="string"> 1</span></span><br><span class="line"><span class="string">第2次  </span>|<span class="string"> 检查最后一位是1 → count+1 </span>|<span class="string"> 111 → 右移成 11  </span>|<span class="string"> 2</span></span><br><span class="line"><span class="string">第3次  </span>|<span class="string"> 检查最后一位是1 → count+1 </span>|<span class="string"> 11 → 右移成 1   </span>|<span class="string"> 3</span></span><br><span class="line"><span class="string">第4次  </span>|<span class="string"> 检查最后一位是1 → count+1 </span>|<span class="string"> 1 → 右移成 0    </span>|<span class="string"> 4</span></span><br><span class="line"><span class="string">第5次  </span>|<span class="string"> 最后一位是0 → 终止       </span>|<span class="string">                </span>|<span class="string"> 最终结果4</span></span><br></pre></td></tr></table></figure>
<ol>
<li><strong><code>num &amp; 1</code></strong>
<ul>
<li>二进制末位探测器：结果为 <code>1</code> 表示末位是 <code>1</code>，<code>0</code> 表示末位是 <code>0</code></li>
<li>示例：<code>0b1011 &amp; 1 = 1</code>，<code>0b1010 &amp; 1 = 0</code></li>
</ul>
</li>
<li><strong><code>num &gt;&gt;&gt;= 1</code></strong>
<ul>
<li>无符号右移：将二进制整体向右移动一位，左侧补 <code>0</code></li>
<li>对比 <code>&gt;&gt;</code>（带符号右移）：负数时左侧补 <code>1</code></li>
</ul>
</li>
</ol>
<ul>
<li>需求：实现下面接口，统计当前用户截止当前时间在本月的连续签到天数</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">请求方式</td>
<td style="text-align:center">GET</td>
</tr>
<tr>
<td style="text-align:center">请求路径</td>
<td style="text-align:center">/user/sign/count</td>
</tr>
<tr>
<td style="text-align:center">请求参数</td>
<td style="text-align:center">无</td>
</tr>
<tr>
<td style="text-align:center">返回值</td>
<td style="text-align:center">连续签到天数</td>
</tr>
</tbody>
</table>
<ul>
<li>在UserController中创建对应的方法</li>
</ul>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">&quot;/sign/count&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">signCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> userService.<span class="title">signCount</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在UserServiceImpl中实现方法</li>
</ul>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public Result signCount() &#123;</span><br><span class="line">    <span class="comment">//1. 获取当前用户</span></span><br><span class="line">    Long userId = UserHolder.<span class="built_in">getUser</span>().getId();</span><br><span class="line">    <span class="comment">//2. 获取日期</span></span><br><span class="line">    LocalDateTime <span class="built_in">now</span> = LocalDateTime.<span class="built_in">now</span>();</span><br><span class="line">    <span class="comment">//3. 拼接key</span></span><br><span class="line">    String keySuffix = <span class="built_in">now</span>.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    String key = USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//4. 获取今天是当月第几天(1~31)</span></span><br><span class="line">    int dayOfMonth = <span class="built_in">now</span>.getDayOfMonth();</span><br><span class="line">    <span class="comment">//5. 获取截止至今日的签到记录  BITFIELD key GET uDay 0</span></span><br><span class="line">    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(key, BitFieldSubCommands.create()</span><br><span class="line">            .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> || result.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. 循环遍历</span></span><br><span class="line">    int <span class="built_in">count</span> = <span class="number">0</span>;</span><br><span class="line">    Long num = result.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((num &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">count</span>++;</span><br><span class="line">        <span class="comment">//数字右移，抛弃最后一位</span></span><br><span class="line">        num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(<span class="built_in">count</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用PostMan发送请求，可以手动修改redis中的签到数据多次测试，发请求的时候还是要注意携带登录用户的token</li>
</ul>
<h2 id="UV统计">UV统计</h2>
<h3 id="HyperLogLog">HyperLogLog</h3>
<ul>
<li>UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。</li>
<li>PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</li>
<li>本博客的首页侧边栏就有本站访客量和本站总访问量，对应的就是UV和PV</li>
<li>通常来说PV会比UV大很多，所以衡量同一个网站的访问量，我们需要综合考虑很多因素。</li>
<li>UV统计在服务端做会很麻烦，因为要判断该用户是否已经统计过了，需要将统计过的信息保存，但是如果每个访问的用户都保存到Redis中，那么数据库会非常恐怖，那么该如何处理呢？</li>
<li>HyperLogLog(HLL)是从Loglog算法派生的概率算法，用户确定非常大的集合基数，而不需要存储其所有值，算法相关原理可以参考下面这篇文章：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a></li>
<li>Redis中的HLL是基于string结构实现的，单个HLL的内存<code>永远小于16kb</code>，<code>内存占用低</code>的令人发指！作为代价，其测量结果是概率性的，<code>有小于0.81％的误差</code>。不过对于UV统计来说，这完全可以忽略。</li>
<li>常用的三个方法</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">PFADD key <span class="keyword">element</span> [<span class="keyword">element</span>...]</span><br><span class="line">summary: Adds <span class="keyword">the</span> specified elements <span class="built_in">to</span> <span class="keyword">the</span> specified HyperLogLog</span><br><span class="line"></span><br><span class="line">PFCOUNT key [key ...]</span><br><span class="line">Return <span class="keyword">the</span> approximated cardinality <span class="keyword">of</span> <span class="keyword">the</span> <span class="built_in">set</span>(s) observed <span class="keyword">by</span> <span class="keyword">the</span> HyperLogLog <span class="keyword">at</span> key(s).</span><br><span class="line"></span><br><span class="line">PFMERGE destkey sourcekey [sourcekey ...]</span><br><span class="line">lnternal commands <span class="keyword">for</span> debugging HyperLogLog values</span><br></pre></td></tr></table></figure>
<h3 id="测试百万数据的统计">测试百万数据的统计</h3>
<ul>
<li>使用单元测试，向HyperLogLog中添加100万条数据，看看内存占用是否真的那么低，以及统计误差如何</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> testHyperLogLog() &#123;</span><br><span class="line">    String[] users = <span class="keyword">new</span> String[<span class="number">1000</span>];</span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        j = i % <span class="number">1000</span>;</span><br><span class="line">        users[j] = <span class="string">&quot;user_&quot;</span> + i;</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">999</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(<span class="string">&quot;HLL&quot;</span>, users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Long</span> <span class="keyword">count</span> = stringRedisTemplate.opsForHyperLogLog().<span class="keyword">size</span>(<span class="string">&quot;HLL&quot;</span>);</span><br><span class="line">    System.out.<span class="keyword">println</span>(<span class="string">&quot;count = &quot;</span> + <span class="keyword">count</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>插入100W条数据，得到的count为997593，误差率为0.002407%</li>
<li>去Redis图形化界面中查看占用情况为：12.3K字节</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Redis项目笔记</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://yjyrichard.github.io/posts/858e11d8.html">https://yjyrichard.github.io/posts/858e11d8.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Yangjiayu</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2025-04-15</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2025-04-15</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>项目</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂作者</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://bilibili123.oss-cn-beijing.aliyuncs.com/about/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98.jpg" target="_blank"><img class="post-qr-code-img" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/about/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://bilibili123.oss-cn-beijing.aliyuncs.com/about/%E6%94%AF%E4%BB%98%E5%AE%9D.jpg" target="_blank"><img class="post-qr-code-img" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/about/%E6%94%AF%E4%BB%98%E5%AE%9D.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/e255a10a.html"><img class="prev-cover" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/2.png" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">计算机网络</div></div></a></div><div class="next-post pull-right"><a href="/posts/8610680.html"><img class="next-cover" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/16.png" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">大模型的token究竟是啥?</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/3a863a5f.html" title="后台管理系统Vue搭建"><img class="cover" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-12</div><div class="title">后台管理系统Vue搭建</div></div></a></div><div><a href="/posts/f8039f9d.html" title="Excel实现导入导出"><img class="cover" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/6.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-12</div><div class="title">Excel实现导入导出</div></div></a></div><div><a href="/posts/fac4a2c4.html" title="SpringBoot3+Vue3实现登录注册功能"><img class="cover" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/7.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-12</div><div class="title">SpringBoot3+Vue3实现登录注册功能</div></div></a></div><div><a href="/posts/2746ea03.html" title="使用Vue3集成Element-Plus快速搭建一个管理系统的页面框架"><img class="cover" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/8.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-12</div><div class="title">使用Vue3集成Element-Plus快速搭建一个管理系统的页面框架</div></div></a></div><div><a href="/posts/d9e956d7.html" title="SpringBoot3+vue3实现增删改查,分页查询,批量删除"><img class="cover" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/1.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-12</div><div class="title">SpringBoot3+vue3实现增删改查,分页查询,批量删除</div></div></a></div><div><a href="/posts/df7753ac.html" title="Springboot3 + vue3实现jwt登录鉴权"><img class="cover" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/7.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-12</div><div class="title">Springboot3 + vue3实现jwt登录鉴权</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">Redis项目笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97"><span class="toc-text">达人探店</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">发布探店笔记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">查看探店笔记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD"><span class="toc-text">点赞功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-text">点赞排行榜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81SortedSet-%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="toc-text">一、SortedSet 核心特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%B8%B8%E7%94%A8-Redis-SortedSet-API%EF%BC%88Java-Spring-Data-Redis%EF%BC%89"><span class="toc-text">二、常用 Redis SortedSet API（Java Spring Data Redis）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0-%E6%9B%B4%E6%96%B0%E6%88%90%E5%91%98"><span class="toc-text">1. 添加&#x2F;更新成员</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%A7%BB%E9%99%A4%E6%88%90%E5%91%98"><span class="toc-text">2. 移除成员</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%8E%B7%E5%8F%96%E6%88%90%E5%91%98score"><span class="toc-text">3. 获取成员score</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%8C%89score%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2%EF%BC%88%E5%8D%87%E5%BA%8F%EF%BC%89"><span class="toc-text">4. 按score范围查询（升序）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%8C%89score%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2%EF%BC%88%E9%99%8D%E5%BA%8F%EF%BC%89"><span class="toc-text">5. 按score范围查询（降序）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E8%8E%B7%E5%8F%96%E6%8E%92%E5%90%8D%EF%BC%88%E5%8D%87%E5%BA%8F%EF%BC%89"><span class="toc-text">6. 获取排名（升序）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E8%8E%B7%E5%8F%96%E6%8E%92%E5%90%8D%EF%BC%88%E9%99%8D%E5%BA%8F%EF%BC%89"><span class="toc-text">7. 获取排名（降序）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%82%A8%E7%9A%84%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-text">三、您的代码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-SortedSet%E6%8E%92%E5%BA%8F%E6%96%B9%E5%90%91"><span class="toc-text">1. SortedSet排序方向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%BD%9C%E5%9C%A8%E4%BC%98%E5%8C%96%E7%82%B9"><span class="toc-text">2. 潜在优化点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">3. 数据一致性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81SortedSet-%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF"><span class="toc-text">四、SortedSet 典型场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%8B%BC%E6%8E%A5-idsStr%EF%BC%9F"><span class="toc-text">为什么要拼接 idsStr？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-likeBlog-%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">1. likeBlog 方法的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-queryBlogLikes-%E6%96%B9%E6%B3%95%E7%9A%84%E7%9F%9B%E7%9B%BE"><span class="toc-text">2. queryBlogLikes 方法的矛盾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%A0%B9%E6%9C%AC%E9%97%AE%E9%A2%98%EF%BC%9A%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%E9%94%99%E8%AF%AF"><span class="toc-text">3. 根本问题：数据结构设计错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88"><span class="toc-text">正确设计方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E7%94%A8-ZSet-%E7%BB%9F%E8%AE%A1%E7%94%A8%E6%88%B7%E7%82%B9%E8%B5%9E%E6%AC%A1%E6%95%B0"><span class="toc-text">方案一：用 ZSet 统计用户点赞次数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E7%94%A8-ZSet-%E8%AE%B0%E5%BD%95%E7%94%A8%E6%88%B7%E7%82%B9%E8%B5%9E%E6%97%B6%E9%97%B4-Hash-%E7%BB%9F%E8%AE%A1%E7%82%B9%E8%B5%9E%E6%AC%A1%E6%95%B0"><span class="toc-text">方案二：用 ZSet 记录用户点赞时间 + Hash 统计点赞次数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8"><span class="toc-text">好友关注</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8%E5%92%8C%E5%8F%96%E6%B6%88%E5%85%B3%E6%B3%A8"><span class="toc-text">关注和取消关注</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8"><span class="toc-text">共同关注</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-text">Feed流实现方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%94%B6%E4%BB%B6%E7%AE%B1"><span class="toc-text">实现分页查询收件箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%94%A8%E9%80%94"><span class="toc-text">常见用途</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%9F%A5%E8%AF%A2"><span class="toc-text">2. 第一次查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%9F%A5%E8%AF%A2"><span class="toc-text">3. 第二次查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%AC%AC%E4%B8%89%E6%AC%A1%E6%9F%A5%E8%AF%A2"><span class="toc-text">4. 第三次查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%80%BB%E7%BB%93%E8%A7%84%E5%BE%8B"><span class="toc-text">5. 总结规律</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%9B%9E%E5%88%B0%E4%BD%A0%E7%9A%84Redis%E4%BE%8B%E5%AD%90"><span class="toc-text">6. 回到你的Redis例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%BF%99%E6%A0%B7%E8%AE%BE%E8%AE%A1%EF%BC%9F"><span class="toc-text">7. 为什么需要这样设计？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7"><span class="toc-text">附近商户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GEO%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">GEO数据结构的基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%BA%97%E9%93%BA%E6%95%B0%E6%8D%AE%E5%88%B0GEO"><span class="toc-text">导入店铺数据到GEO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-text">实现附近商户功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0"><span class="toc-text">用户签到</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BitMap%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA"><span class="toc-text">BitMap功能演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-text">实现签到功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E7%BB%AD%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1"><span class="toc-text">连续签到统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%90%E5%B8%A7%E6%8B%86%E8%A7%A3%EF%BC%88%E4%BB%A5-num-15-%E4%B8%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">逐帧拆解（以 num&#x3D;15 为例）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UV%E7%BB%9F%E8%AE%A1"><span class="toc-text">UV统计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HyperLogLog"><span class="toc-text">HyperLogLog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%99%BE%E4%B8%87%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%9F%E8%AE%A1"><span class="toc-text">测试百万数据的统计</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>再看看那个光点，它就在这里，这是家园，这是我们 —— 你所爱的每一个人，你认识的一个人，你听说过的每一个人，曾经有过的每一个人，都在它上面度过他们的一生✨</div><div class="btn-xz-box"><a class="btn-xz" href="#">点击开启星辰之旅</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a href="/social/link/">我的朋友</a><a href="/comments/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/box/Gallery/">我的画廊</a><a href="/personal/bb/">我的唠叨</a></li><li><a href="/site/time/">建设进程</a><a href="/site/census/">网站统计</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链⌛</p><div class="ft-img-group"></div></div></div><div class="copyright"><span><b>&copy;2025</b></span><span><b>&nbsp;&nbsp;By Yangjiayu</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v6.3.0"><img src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v4.3.1"><img src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="本站采用多线部署，主线路托管于Vercel"><img src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="本站数据分析得益于51la技术支持"><img src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="本站已加入萌ICP豪华套餐，萌ICP备20226665号"><img src="https://sourcebucket.s3.ladydaily.com/badge/萌ICP备-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="本网站经Service Worker分流至缤纷云对象存储"><img src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-缤纷云-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="本站使用网盾星球提供CDN加速与防护"><img src="https://sourcebucket.s3.ladydaily.com/badge/CDN-网盾星球-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本网站源码由Github提供存储仓库"><img src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="右键模式" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://www.312782.xyz/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://www.312782.xyz/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><a class="magnet_link_more"  href="https://yjyrichard.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/d522d575.html" alt=""><img width="48" height="48" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/9.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-15</span><a class="blog-slider__title" href="posts/d522d575.html" alt="">小程序起步</a><div class="blog-slider__text">初识小程序</div><a class="blog-slider__button" href="posts/d522d575.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/8610680.html" alt=""><img width="48" height="48" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/16.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-15</span><a class="blog-slider__title" href="posts/8610680.html" alt="">大模型的token究竟是啥?</a><div class="blog-slider__text">大模型的token究竟是啥?</div><a class="blog-slider__button" href="posts/8610680.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/5c2f4951.html" alt=""><img width="48" height="48" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/1.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-15</span><a class="blog-slider__title" href="posts/5c2f4951.html" alt="">基础数据结构(3)</a><div class="blog-slider__text">栈，队列，堆，二叉树</div><a class="blog-slider__button" href="posts/5c2f4951.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/45347810.html" alt=""><img width="48" height="48" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/1.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-15</span><a class="blog-slider__title" href="posts/45347810.html" alt="">基础数据结构(2)</a><div class="blog-slider__text">递归</div><a class="blog-slider__button" href="posts/45347810.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/6e192bd3.html" alt=""><img width="48" height="48" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/9.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-15</span><a class="blog-slider__title" href="posts/6e192bd3.html" alt="">基础数据结构(1)</a><div class="blog-slider__text">数组与链表</div><a class="blog-slider__button" href="posts/6e192bd3.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/3ec27523.html" alt=""><img width="48" height="48" src="https://bilibili123.oss-cn-beijing.aliyuncs.com/websitepic/12.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-21</span><a class="blog-slider__title" href="posts/3ec27523.html" alt="">微信支付</a><div class="blog-slider__text">java整合微信的网页支付包含原理</div><a class="blog-slider__button" href="posts/3ec27523.html" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('blog-slider swiper-container-fade swiper-container-horizontal');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('catalog_magnet');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s·');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('pagination');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__jackInTheBox');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>